<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OwaMailB2 - Service Detail | Griffin PF Deployment AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link rel="stylesheet" href="./shared/fluent-ui.css">
    <link rel="stylesheet" href="./shared/dashboard.css"><!-- added shared layout/icons -->
    <style>
        /* ...removed global token + sidebar duplication... */
        /* Keep only page-specific styles */
        .pipeline-card { transition:all .1s cubic-bezier(.33,0,.67,1); }
        .pipeline-card:hover { box-shadow:var(--shadow4); }
        .pipeline-card.default-pipeline { border-color: var(--colorBrandForeground1); background:#e3f2fd; }
        .config-actions { opacity:0; transition:opacity .2s; }
        .table-row:hover .config-actions { opacity:1; }
        .search-highlight { background:rgba(59,130,246,.1); border:2px solid #3B82F6; }
        .loading-overlay { position:fixed; inset:0; backdrop-filter:blur(3px); display:flex; align-items:center; justify-content:center; z-index:60; }
        .loading-overlay.hidden { display:none; }
        .star-toggle svg.feather-star { stroke:currentColor; }
        .star-toggle.active svg.feather-star { fill:currentColor; }
    </style>
</head>
<body>
    <div id="app-sidebar"></div><!-- shared sidebar injected -->
    <div class="main-content"><!-- replaced previous margin-left logic via shared layout -->
        <!-- Fluent Navigation -->
        <nav class="fluent-card" style="margin: 0; border-radius: 0; border-left: none; border-right: none; border-top: none;">
            <div class="container mx-auto px-6">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-3">
                            <div>
                                <h1 class="text-lg font-semibold" style="color: var(--colorNeutralForeground1);">Service Detail</h1>
                                <p class="fluent-text-caption1">Cross Virtual Environment Service Management</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background: var(--colorNeutralBackground3);">
                            <i data-feather="user" class="fluent-icon" style="color: var(--colorNeutralForeground3);"></i>
                        </div>
                        <span class="text-sm" style="color: var(--colorNeutralForeground2);">John Doe</span>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container mx-auto px-6 py-8">
            <!-- Error State -->
            <div id="errorState" class="error-state hidden">
                <div class="flex items-center">
                    <i data-feather="alert-circle" class="w-5 h-5 mr-2"></i>
                    <span id="errorMessage">An error occurred while loading service data.</span>
                    <button onclick="retryLoad()" class="ml-auto px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">
                        Retry
                    </button>
                </div>
            </div>

            <!-- Breadcrumb -->
            <nav class="flex items-center space-x-2 text-sm mb-6" style="color: var(--colorNeutralForeground3);">
                <a href="services-management.html" class="hover:text-blue-600 transition-colors" style="color: var(--colorBrandForeground1);">Services Management</a>
                <i data-feather="chevron-right" class="w-4 h-4"></i>
                <span style="color: var(--colorNeutralForeground1); font-weight: 500;" id="serviceName">OwaMailB2</span>
            </nav>

            <!-- Service Header -->
            <div class="fluent-card mb-8">
                <div class="p-8">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-4">
                            <div class="w-16 h-16 rounded-xl flex items-center justify-center" id="serviceIcon" style="background: #dff6dd;">
                                <i data-feather="mail" class="w-8 h-8" style="color: #107c10;"></i>
                            </div>
                            <div>
                                <div class="flex items-center space-x-3 mb-1">
                                    <h1 class="fluent-text-title1" id="serviceTitle">OwaMailB2</h1>
                                    <button id="favoriteBtn" onclick="toggleFavorite()" style="color: #faa06b; transition: opacity 0.1s;" class="hover:opacity-80" title="Add to favorites">
                                        <i data-feather="star" class="w-6 h-6"></i>
                                    </button>
                                </div>
                                <p class="fluent-text-body1 mt-1" id="serviceDescription">Outlook Web App Mail Backend Service</p>
                                <div class="flex items-center space-x-4 mt-3">
                                    <span class="fluent-badge fluent-badge-success" id="serviceType">Exchange Service</span>
                                    <span class="text-sm" style="color: var(--colorNeutralForeground3);">Last updated: 2 hours ago</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button onclick="refreshData()" class="fluent-button fluent-button-subtle" title="Refresh data">
                                <i data-feather="refresh-cw" class="fluent-icon inline mr-2"></i>Refresh
                            </button>
                            <button onclick="bulkDeploy()" class="fluent-button fluent-button-primary">
                                <i data-feather="upload" class="fluent-icon inline mr-2"></i>Deploy to All VEs
                            </button>
                        </div>
                    </div>
                    
                    <!-- Service Stats Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="text-center p-4 rounded-lg border transition-all" style="border-color: var(--colorNeutralStroke2); background: var(--colorNeutralBackground2);">
                            <p class="text-3xl font-bold mb-2" style="color: var(--colorBrandForeground1);" id="totalVEs">2</p>
                            <p class="text-sm" style="color: var(--colorNeutralForeground2);">Total VE Instances</p>
                        </div>
                        <div class="text-center p-4 rounded-lg border transition-all" style="border-color: var(--colorNeutralStroke2); background: var(--colorNeutralBackground2);">
                            <p class="text-3xl font-bold mb-2" style="color: #107c10;" id="deployedVEs">2</p>
                            <p class="text-sm" style="color: var(--colorNeutralForeground2);">Deployed VEs</p>
                        </div>
                        <div onclick="showPipelineManagementModal()" class="text-center p-4 rounded-lg border transition-all cursor-pointer hover:bg-blue-50" style="border-color: var(--colorNeutralStroke2); background: var(--colorNeutralBackground2);" onmouseover="this.style.borderColor='var(--colorBrandForeground1)'" onmouseout="this.style.borderColor='var(--colorNeutralStroke2)'">
                            <p class="text-3xl font-bold mb-2" style="color: #5c2d91;" id="activePipelines">3</p>
                            <p class="text-sm" style="color: var(--colorNeutralForeground2);">Active Pipelines</p>
                            <p class="text-xs mt-1 opacity-75" style="color: #5c2d91;">Click to view</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pipeline Management Modal -->
            <div id="pipelineManagementModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center" style="z-index: 1050;">
                <div class="bg-white rounded-xl shadow-xl max-w-6xl w-full mx-4 max-h-[90vh] flex flex-col">
                    <div class="p-6 border-b border-gray-100 flex-shrink-0">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <i data-feather="layers" class="w-6 h-6" style="color: var(--colorBrandForeground1);"></i>
                                <h3 class="text-lg font-semibold text-gray-900">Pipeline Management - <span id="modalServiceName">OwaMailB2</span></h3>
                            </div>
                            <button onclick="closePipelineManagementModal()" class="text-gray-400 hover:text-gray-600">
                                <i data-feather="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <p class="text-sm text-gray-500 mt-2">View all active pipelines for this service across virtual environments</p>
                    </div>
                    
                    <div class="flex-1 p-6 overflow-y-auto">
                        <div id="modalPipelineCardsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Pipeline cards will be generated here -->
                        </div>
                    </div>
                    
                    <div class="px-6 py-4 border-t border-gray-100 flex justify-end flex-shrink-0">
                        <button onclick="closePipelineManagementModal()" class="fluent-button fluent-button-subtle">
                            Close
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading Overlay -->
            <div id="loadingOverlay" class="loading-overlay hidden">
                <div class="loading-content">
                    <div class="animate-spin w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                    <h3 class="text-lg font-semibold mb-2">Processing...</h3>
                    <p id="loadingMessage">Please wait while we process your request.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Error handling
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').classList.remove('hidden');
        }
        
        function hideError() {
            document.getElementById('errorState').classList.add('hidden');
        }
        
        function retryLoad() {
            hideError();
            initializePage();
        }
        
        // Loading states
        function showLoading(message = 'Loading...') {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        
        function showTableLoading() {
            document.getElementById('tableLoadingState').classList.remove('hidden');
            document.getElementById('tableContainer').style.opacity = '0.5';
        }
        
        function hideTableLoading() {
            document.getElementById('tableLoadingState').classList.add('hidden');
            document.getElementById('tableContainer').style.opacity = '1';
        }
        
        // Service data structure with VEs
        const serviceData = {
            'OwaMailB2': {
                name: 'OwaMailB2',
                description: 'Outlook Web App Mail Backend Service',
                type: 'Exchange Service',
                icon: 'mail',
                iconColor: '#107c10',
                iconBg: '#dff6dd',
                latestVersion: 'v2.1.234',
                activePipelines: 3,
                ves: [
                    {
                        id: 'sovbase',
                        name: 'SovBase',
                        type: 'B Type',
                        status: 'deployed',
                        version: 'v2.1.234',
                        lastDeploy: '2 hours ago',
                        icon: 'server',
                        iconBg: 'linear-gradient(135deg, #0f6cbd 0%, #115ea3 100%)',
                        canDeploy: true
                    },
                    {
                        id: 'owamailb2-sov',
                        name: 'OwaMailB2-SOV',
                        type: 'B2 Type',
                        status: 'deployed',
                        version: 'v2.1.234',
                        lastDeploy: '1 hour ago',
                        icon: 'mail',
                        iconBg: 'linear-gradient(135deg, #107c10 0%, #0b5c0a 100%)',
                        canDeploy: true
                    }
                ]
            }
        };

        // Global state
        const appState = {
            currentService: null
        };

        // Initialize page
        function initializePage() {
            try {
                const serviceName = getServiceFromURL();
                const svc = serviceData[serviceName];
                
                if (!svc) {
                    showError(`Service "${serviceName}" not found. Please check the URL and try again.`);
                    return;
                }
                
                appState.currentService = svc;
                
                updateServiceHeaderMetrics(svc);
                initializePipelines();
                updateDefaultPipelineDisplay();
                
                if (window.refreshFeatherIcons) window.refreshFeatherIcons();
            } catch (e) {
                console.error(e);
                showError('Initialization failed.');
            }
        }

        function updateServiceHeaderMetrics(service) {
            document.getElementById('serviceName').textContent = serviceNameFromURL();
            document.getElementById('serviceTitle').textContent = serviceNameFromURL();
            document.getElementById('serviceDescription').textContent = 'Outlook Web App Mail Backend Service';
            document.getElementById('serviceType').textContent = 'Exchange Service';
            document.getElementById('totalVEs').textContent = service.PipelineId ? 2 : 0;
            document.getElementById('deployedVEs').textContent = service.PipelineId ? 2 : 0;
            document.getElementById('activePipelines').textContent = 3;
        }

        // Helpers
        function serviceNameFromURL() {
            const p = new URLSearchParams(location.search);
            return p.get('service') || 'OwaMailB2';
        }
        function getServiceFromURL() { return serviceNameFromURL(); }

        // Pipeline management initialization
        function initializePipelines() {
            const serviceName = appState.currentService.name;
            const pipelineIds = [1418, 33874, 31234]; // Example pipeline IDs
            
            const container = document.getElementById('modalPipelineCardsContainer');
            container.innerHTML = ''; // Clear existing cards
            
            pipelineIds.forEach(id => {
                const config = pipelineConfigs[id];
                if (config) {
                    const card = createPipelineCard(config);
                    container.appendChild(card);
                }
            });
        }

        function createPipelineCard(config) {
            const card = document.createElement('div');
            card.className = 'fluent-card p-4 cursor-pointer';

            card.innerHTML = `
                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center space-x-2">
                        <div class="w-6 h-6 bg-gray-100 rounded flex items-center justify-center">
                            <i data-feather="${config.icon}" class="w-3 h-3 text-gray-600"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">${config.name}</h4>
                            <p class="text-xs text-gray-500">ID: ${config.id}</p>
                        </div>
                    </div>
                    <span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">${config.type}</span>
                </div>
                <p class="text-xs text-gray-600 mb-3">${config.description}</p>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Latest Build:</span>
                        <span class="font-mono text-gray-900">${config.latestBuild}</span>
                    </div>
                    <div class="bg-gray-50 rounded p-2">
                        <div class="flex items-center justify-between">
                            <p class="font-mono text-xs text-gray-700 break-all flex-1 mr-2">${config.dropUrl}</p>
                            <button onclick="copyDropUrl('${config.dropUrl}')" class="px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-xs transition-colors" title="Copy URL">
                                <i data-feather="copy" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-t border-gray-100 text-center">
                    <span class="text-xs text-gray-500">Pipeline Status: Active</span>
                </div>
            `;

            return card;
        }

        // Copy drop URL functionality
        function copyDropUrl(url) {
            navigator.clipboard.writeText(url).then(() => {
                showNotification('URL Copied', 'Drop URL has been copied to clipboard');
            }, (err) => {
                console.error('Copy failed', err);
                showNotification('Copy Failed', 'Unable to copy URL to clipboard');
            });
        }

        // Show Pipeline Management Modal
        function showPipelineManagementModal() {
            document.getElementById('modalServiceName').textContent = appState.currentService.name;
            
            const container = document.getElementById('modalPipelineCardsContainer');
            container.innerHTML = '';
            
            // Get all pipeline IDs for this service
            const pipelineIds = [1418, 33874, 31234]; // From the service data
            
            pipelineIds.forEach(pipelineId => {
                const config = pipelineConfigs[pipelineId];
                if (config) {
                    const card = createViewOnlyPipelineCard(pipelineId, config);
                    container.appendChild(card);
                }
            });
            
            document.getElementById('pipelineManagementModal').classList.remove('hidden');
            if (window.refreshFeatherIcons) window.refreshFeatherIcons(); // replaced
        }

        // Close Pipeline Management Modal
        function closePipelineManagementModal() {
            document.getElementById('pipelineManagementModal').classList.add('hidden');
        }

        // Create view-only pipeline card (without default setting functionality)
        function createViewOnlyPipelineCard(pipelineId, config) {
            const card = document.createElement('div');
            card.className = 'fluent-card p-4 cursor-default';

            const colorClasses = {
                'blue': 'bg-blue-100 text-blue-700',
                'purple': 'bg-purple-100 text-purple-700',
                'green': 'bg-green-100 text-green-700'
            };

            card.innerHTML = `
                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center space-x-2">
                        <div class="w-6 h-6 bg-gray-100 rounded flex items-center justify-center">
                            <i data-feather="${config.icon}" class="w-3 h-3 text-gray-600"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">${config.name}</h4>
                            <p class="text-xs text-gray-500">ID: ${pipelineId}</p>
                        </div>
                    </div>
                    <span class="px-2 py-1 ${colorClasses[config.color] || 'bg-gray-100 text-gray-700'} text-xs rounded">${config.type}</span>
                </div>
                <p class="text-xs text-gray-600 mb-3">${config.description}</p>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Latest Build:</span>
                        <span class="font-mono text-gray-900">${config.latestBuild}</span>
                    </div>
                    <div class="bg-gray-50 rounded p-2">
                        <div class="flex items-center justify-between">
                            <p class="font-mono text-xs text-gray-700 break-all flex-1 mr-2">${config.dropUrl}</p>
                            <button onclick="copyDropUrl('${config.dropUrl}')" class="px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-xs transition-colors" title="Copy URL">
                                <i data-feather="copy" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-t border-gray-100 text-center">
                    <span class="text-xs text-gray-500">Pipeline Status: Active</span>
                </div>
            `;

            return card;
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('pipelineManagementModal');
            if (event.target === modal) {
                closePipelineManagementModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('pipelineManagementModal');
                if (!modal.classList.contains('hidden')) {
                    closePipelineManagementModal();
                }
            }
        });

        // Shared sidebar context
        window.SIDEBAR_ACTIVE = 'services';
        window.SIDEBAR_FAVORITES = [
            { name:'SovBase', query:'SovBase' },
            { name:'ModelBSov', query:'ModelBSov' },
            { name:'OwaMailB2-SOV', query:'OwaMailB2-SOV' }
        ];
    </script>
    <script src="./shared/sidebar.js"></script>
    <script>
        if (window.refreshFeatherIcons) window.refreshFeatherIcons();
    </script>
</body>
</html>