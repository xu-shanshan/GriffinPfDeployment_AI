<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Services Management - Griffin PF Deployment AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link rel="stylesheet" href="./shared/css/common.css">
    <link rel="stylesheet" href="./shared/css/layout.css">
    <link rel="stylesheet" href="./pages/services-management.css">
</head>
<body>
    <a href="#mainContent" class="visually-hidden" aria-label="Skip to main content">Skip to main content</a>
    <div id="app-sidebar"></div>
    <div class="main-content" id="mainContent" role="main" aria-label="Services Management">
        <div id="app-header"></div>
        <div class="web-container content-area">
            <!-- Search and Filters -->
            <div class="fluent-card section-spacing">
                <div class="p-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="relative">
                                <i data-feather="search" class="fluent-icon absolute left-2 top-1/2 transform -translate-y-1/2 icon-muted"></i>
                                <input type="text"
                                       id="searchInput"
                                       aria-label="Search services or virtual environments"
                                       placeholder="Search by service name or VE name..."
                                       class="fluent-input with-icon w-80"
                                       oninput="performSearch()">
                            </div>
                            <select class="fluent-select"
                                    aria-label="Filter by service type"
                                    onchange="applyFilters()">
                                <option>All Service Types</option>
                                <option>Exchange Services</option>
                                <option>Graph Services</option>
                                <option>Outlook Services</option>
                                <option>Core Services</option>
                            </select>
                            <select class="fluent-select"
                                    aria-label="Filter by deployment status"
                                    onchange="applyFilters()">
                                <option>All Deployment Status</option>
                                <option>Ready to Deploy</option>
                                <option>Deployed</option>
                                <option>Not Deployed</option>
                                <option>Configuration Issues</option>
                            </select>
                            <button type="button" onclick="clearSearch()" class="fluent-button fluent-button-subtle">
                                Clear All
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Services Cards Grid -->
            <div id="servicesGrid" class="services-grid section-spacing"></div>

            <!-- Pagination -->
            <div class="flex items-center justify-between">
                <div class="fluent-text-body1">
                    Showing 1-6 of 156 services
                </div>
                <nav class="flex space-x-1">
                    <button type="button" aria-label="Previous page" class="fluent-button fluent-button-subtle px-3 py-2 icon-muted">
                        <i data-feather="chevron-left" class="fluent-icon"></i>
                    </button>
                    <button type="button" class="fluent-button fluent-button-primary px-3 py-2 text-sm">1</button>
                    <button type="button" class="fluent-button fluent-button-subtle px-3 py-2 text-sm">2</button>
                    <button type="button" class="fluent-button fluent-button-subtle px-3 py-2 text-sm">3</button>
                    <button type="button" aria-label="Next page" class="fluent-button fluent-button-subtle px-3 py-2 icon-muted">
                        <i data-feather="chevron-right" class="fluent-icon"></i>
                    </button>
                </nav>
            </div>
        </div>
    </div>
    <script src="./shared/js/header.js"></script>
    <script>
      initHeader({ title:'Services Management', subtitle:'Manage and monitor all services across virtual environments', user:{ name:'John Doe' } });
    </script>
    <script>
        // Mock services data (icon retained but not displayed now)
        const serviceMockData = [
            {
                name: 'OwaMailB2',
                description: 'Outlook Web App Mail Backend Service',
                icon: { name: 'mail', bg: '#dff6dd', color: '#107c10' }, // no longer rendered
                status: 'Active', statusClass: 'success',
                instances: 2, deployed: 2, version: 'v2.1.234',
                veBadges: [{ name: 'SovBase', type: 'b' }, { name: 'OwaMailB2-SOV', type: 'b2' }],
                favorite: true
            },
            { name: 'GraphConnectors', description: 'Graph Connectors Service for data integration',
              icon: { name: 'zap', class: 'icon-bg-orange' },
              status: 'Not Deployed', statusClass: 'neutral',
              instances: 1, deployed: 0, version: null,
              veBadges: [{ name: 'SovBase', type: 'b' }, { name: 'GraphConnectorsB2-SOV', type: 'b2' }],
              favorite: false },
            { name: 'FlowControl', description: 'Flow Control Service for managing data streams',
              icon: { name: 'activity', class: 'icon-bg-activity' },
              status: 'Config Issue', statusClass: 'warning',
              instances: 1, deployed: 0, version: null,
              veBadges: [{ name: 'SovBase', type: 'b' }, { name: 'FlowControlB2-SOV', type: 'b2' }],
              favorite: false },
            { name: 'Todo', description: 'Task management and todo list service',
              icon: { name: 'check-square', class: 'icon-bg-blue' },
              status: 'Active', statusClass: 'success',
              instances: 1, deployed: 1, version: 'v1.0.0',
              veBadges: [{ name: 'TodoB2-SOV', type: 'b2' }],
              favorite: false },
            { name: 'Exchange', description: 'Core Exchange Server services and components',
              icon: { name: 'server', class: 'icon-bg-purple' },
              status: 'Active', statusClass: 'success',
              instances: 2, deployed: 2, version: 'v15.2.234',
              veBadges: [{ name: 'SovBase', type: 'b' }, { name: 'ModelBSov', type: 'b' }],
              favorite: false }
        ];

        const favoriteVEs = [
            { name:'SovBase' },
            { name:'ModelBSov' },
            { name:'OwaMailB2-SOV' }
        ];

        // Helper to show an empty-state placeholder if nothing rendered
        function renderEmptyServicesMessage() {
            const wrap = document.getElementById('servicesGrid');
            if (!wrap) return;
            wrap.innerHTML = `<div class="fluent-card p-8 text-center" role="status" aria-live="polite">
                <p class="fluent-text-title2" style="margin:0 0 4px;">No Services</p>
                <p class="fluent-text-body1">No services match current filters.</p>
            </div>`;
        }

        function serviceStatusBadge(s) {
            if (s.statusClass === 'success') return `<span class="fluent-badge fluent-badge-success">${s.status}</span>`;
            if (s.statusClass === 'neutral') return `<span class="fluent-badge fluent-badge-neutral">${s.status}</span>`;
            if (s.statusClass === 'warning') return `<span class="fluent-badge badge-warning">${s.status}</span>`;
            return `<span class="fluent-badge">${s.status}</span>`;
        }

        function renderServices(list = serviceMockData) {
            const wrap = document.getElementById('servicesGrid');
            if (!wrap) {
                console.error('[services-management] #servicesGrid not found when renderServices executed.');
                return;
            }
            console.debug('[services-management] renderServices start. list length =', list?.length);
            wrap.innerHTML = '';
            if (!list || list.length === 0) {
                renderEmptyServicesMessage();
                console.debug('[services-management] empty list -> placeholder shown');
                return;
            }
            list.forEach(s => {
                const card = document.createElement('div');
                card.className = 'service-card fluent-card';
                card.setAttribute('role','button');
                card.setAttribute('tabindex','0');
                card.addEventListener('keydown', e => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        card.click();
                    }
                });
                card.onclick = () => {
                    console.debug('[services-management] navigating to service detail', s.name);
                    window.location.href = `service-detail.html?service=${encodeURIComponent(s.name)}`;
                };
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="fluent-text-title2 m-0">${s.name}</h3>
                        <div class="flex items-center space-x-2">
                            ${serviceStatusBadge(s)}
                            <button type="button" aria-label="Toggle favorite for ${s.name}" class="star-toggle ${s.favorite ? 'active':''}" onclick="event.stopPropagation(); toggleStar(this,'${s.name}')">
                                <i data-feather="star"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mb-6">
                        <div class="text-center">
                            <div class="text-xl font-semibold text-fg-strong">${s.instances}</div>
                            <div class="fluent-text-caption1">VE ${s.instances===1?'Instance':'Instances'}</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xl font-semibold ${s.statusClass==='success' ? 'text-success' : (s.statusClass==='warning' ? 'text-warning' : 'text-muted')}">
                                ${s.deployed}
                            </div>
                            <div class="fluent-text-caption1">${s.statusClass==='warning'?'Config Issue':'Deployed'}</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xl font-semibold ${s.version ? 'text-accent':'text-muted'}">${s.version || 'N/A'}</div>
                            <div class="fluent-text-caption1">Latest Version</div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between pt-4 divider-top card-footer">
                        <span class="fluent-text-body1">Click to explore</span>
                        <i data-feather="chevron-right" class="fluent-icon icon-muted"></i>
                    </div>
                `;
                wrap.appendChild(card);
            });
            console.debug('[services-management] appended cards =', wrap.children.length);
            if (wrap.children.length === 0) {
                // Fallback diagnostic box
                wrap.innerHTML = `<div class="fluent-card p-6" style="border:1px solid #d13438;">
                    <p class="fluent-text-title2" style="color:#d13438;margin:0 0 4px;">Render Failure</p>
                    <p class="fluent-text-body1">Cards failed to mount. Check console for errors in earlier scripts.</p>
                </div>`;
            } else {
                // Force icon replacement after paint
                requestAnimationFrame(() => { if (window.refreshFeatherIcons) window.refreshFeatherIcons(); });
            }
            // Secondary fallback (some layout shifts may clear content)
            setTimeout(() => {
                if (wrap.children.length === 0) {
                    console.warn('[services-management] Post-timeout check: still no children, re-rendering once.');
                    renderServices(list);
                }
            }, 100);
        }

        function performSearch() {
            const term = document.getElementById('searchInput').value.trim().toLowerCase();
            if (!term) return renderServices();
            const filtered = serviceMockData.filter(s =>
                s.name.toLowerCase().includes(term) ||
                s.veBadges.some(v => v.name.toLowerCase().includes(term))
            );
            renderServices(filtered);
        }

        function applyFilters() { renderServices(); }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
            renderServices();
        }

        function toggleStar(btn, name) {
            const active = btn.classList.toggle('active');
            if (active) {
                if (window.addToSidebarFavorites) window.addToSidebarFavorites({ name, query: name, type:'service' });
            } else {
                if (window.removeFromSidebarFavorites) window.removeFromSidebarFavorites(name,'service');
            }
        }

        // Defer initial render until DOM fully parsed to avoid race conditions
        document.addEventListener('DOMContentLoaded', () => {
            console.debug('[services-management] DOMContentLoaded -> initial render');
            renderServices();
            // Sanity verification
            const wrap = document.getElementById('servicesGrid');
            console.debug('[services-management] after initial render child count =', wrap ? wrap.children.length : 'none');
        });
    </script>
    <script>
        window.SIDEBAR_ACTIVE = 'services';
        window.SIDEBAR_FAVORITES = favoriteVEs.map(v => ({ name: v.name, type:'ve' }));
    </script>
    <script src="./shared/js/sidebar.js"></script>
    <script>
        if (window.refreshFeatherIcons) window.refreshFeatherIcons();
    </script>
</body>
</html>