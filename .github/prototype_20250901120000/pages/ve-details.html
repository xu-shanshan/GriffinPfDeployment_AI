<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>VE Details</title>
  <link rel="stylesheet" href="../shared/styles/common.css">
  <link rel="stylesheet" href="../shared/styles/layout.css">
  <link rel="stylesheet" href="ve-details.css">
</head>
<body>
<div class="fluent-layout">
  <div id="app-sidebar"></div>
  <div class="fluent-content">
    <div id="app-header"></div>
    <div class="fluent-main">
      <div class="fluent-breadcrumb"><a href="dashboard.html">VEs</a> / <span id="ve-name-bc"></span></div>
      <h1 class="fluent-section-title" id="ve-title"></h1>
      <div class="fluent-inline">
        <button id="deploy-all-btn" class="fluent-btn">Deploy All Services</button>
        <span class="fluent-meta" id="deploy-hint"></span>
      </div>
      <div class="fluent-divider"></div>
      <table class="fluent-table">
        <thead>
          <tr><th>Service</th><th>Model</th><th>Latest Build</th><th>Actions</th></tr>
        </thead>
        <tbody id="svc-body"></tbody>
      </table>
    </div>
  </div>
</div>
<script src="../shared/js/mockData.js"></script>
<script src="../shared/js/layout.js"></script>
<script>
injectSidebar("dashboard.html");
injectHeader();

var q = parseQuery();
var veName = q.ve;
var ve = getVE(veName);
if(!ve){ document.body.innerHTML="VE not found"; throw new Error(); }

document.getElementById("ve-name-bc").textContent = ve.name;
document.getElementById("ve-title").textContent = ve.name + " ("+ ve.type +", "+ ve.environment +")";
document.getElementById("deploy-hint").textContent = canCurrentUserDeploy()? "You can deploy." : "No deploy permission.";

function renderServices(){
  var body = document.getElementById("svc-body");
  var html="";
  for(var i=0;i<ve.services.length;i++){
    var sName = ve.services[i];
    var svc = getService(sName);
    var drop = composeDropUrl(sName);
    html += '<tr>' +
      '<td><a href="service-details.html?service='+ encodeURIComponent(sName) +'&ve='+ encodeURIComponent(ve.name) +'">'+ sName +'</a></td>' +
      '<td>'+ svc.model +'</td>' +
      '<td>'+ svc.latestBuildVersion +'<br><span class="fluent-meta">'+ drop +'</span></td>' +
      '<td>' +
        '<button class="fluent-btn" onclick="deployService(\''+ sName +'\')" '+(canCurrentUserDeploy()?'':'disabled')+'>Deploy</button>' +
      '</td>' +
    '</tr>';
  }
  body.innerHTML = html;
}
renderServices();

document.getElementById("deploy-all-btn").disabled = !canCurrentUserDeploy();
document.getElementById("deploy-all-btn").onclick = function(){
  if(!canCurrentUserDeploy()) return;
  simulateDeploy({ ve: ve.name, services: ve.services.slice() });
};

function deployService(name){
  if(!canCurrentUserDeploy()) return;
  simulateDeploy({ ve: ve.name, services:[name] });
}
</script>
</body>
</html>
