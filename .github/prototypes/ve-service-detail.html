<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OwaMailB2 - Service Detail | Griffin PF Deployment AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link rel="stylesheet" href="./shared/fluent-ui.css">
    <link rel="stylesheet" href="./shared/common.css"><!-- added -->
    <style>
        /* Page-specific only (removed global tokens + sidebar) */
        .pipeline-card{transition:all .1s cubic-bezier(.33,0,.67,1);}
        .pipeline-card:hover{box-shadow:var(--shadow4);}
        .pipeline-card.default-pipeline{border-color:var(--colorBrandForeground1);background:#e3f2fd;}
        .config-actions{opacity:0;transition:opacity .2s;}
        .table-row:hover .config-actions{opacity:1;}
        .search-highlight{background:rgba(59,130,246,.08);border:2px solid #3B82F6;}
        .star-toggle svg.feather-star{stroke:currentColor;}
        .star-toggle.active svg.feather-star{fill:currentColor;}

        /* Prevent accidental horizontal scroll in this page */
        body, main, .fluent-card { max-width:100%; overflow-x:hidden; }
    </style>
</head>
<body>
    <a href="#mainContent" class="visually-hidden" aria-label="Skip to main content">Skip to main content</a>
    <div id="app-sidebar"></div><!-- shared sidebar injection -->

    <main class="main-content" id="mainContent" role="main" aria-label="VE Service Detail">
        <header class="top-bar" role="banner">
            <div class="web-container">
                <div class="flex justify-between items-center h-app-header">
                    <div>
                        <h1 class="text-lg font-semibold page-title">OwaMailB2 - VE Service Detail</h1>
                        <p class="fluent-text-caption1">Virtual Environment Management</p>
                    </div>
                    <div class="user-profile">
                        <div class="user-avatar">
                            <i data-feather="user" class="fluent-icon user-icon" aria-hidden="true"></i>
                        </div>
                        <span class="text-sm user-name">John Doe</span>
                    </div>
                </div>
            </div>
        </header>

        <div class="web-container content-area">
            <!-- Breadcrumb -->
            <nav class="flex items-center space-x-2 text-sm mb-6 text-muted">
                <a href="ve-management.html" class="text-accent hover:underline">VE Management</a>
                <i data-feather="chevron-right" class="fluent-icon" aria-hidden="true"></i>
                <a href="ve-detail.html?ve=OwaMailB2-SOV" class="text-accent hover:underline">OwaMailB2-SOV</a>
                <i data-feather="chevron-right" class="fluent-icon" aria-hidden="true"></i>
                <span class="font-medium text-fg-strong">OwaMailB2</span>
            </nav>

            <!-- Service Header (unchanged structure except star-toggle class) -->
            <div class="fluent-card mb-8" aria-label="Service header summary">
                <div class="p-8">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 rounded-lg flex items-center justify-center" style="background: #dff6dd;">
                                <i data-feather="mail" class="w-6 h-6" style="color: #107c10;"></i>
                            </div>
                            <div>
                                <div class="flex items-center space-x-3 mb-1">
                                    <h1 class="fluent-text-title1">OwaMailB2</h1>
                                    <button onclick="toggleFavorite()" style="color: var(--colorNeutralForeground3); transition: opacity 0.1s;" class="hover:opacity-80 star-toggle" id="favoriteBtn" aria-label="Toggle favorite">
                                        <i data-feather="star"></i>
                                    </button>
                                </div>
                                <p class="fluent-text-body1 mb-3">Outlook Web App Mail Backend Service</p>
                                <div class="flex items-center space-x-3">
                                    <span class="fluent-badge fluent-badge-neutral">RingPromotion</span>
                                    <span class="fluent-badge fluent-badge-success">B2 Type</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="text-right">
                                <div class="flex items-center space-x-2 mb-1">
                                    <div class="w-2 h-2 rounded-full" style="background: #107c10;"></div>
                                    <span class="text-sm font-medium" style="color: #107c10;">Healthy</span>
                                </div>
                                <div class="text-xs" style="color: var(--colorNeutralForeground3);">Version: 20241220.5</div>
                            </div>
                            <button onclick="showConfigEditor()" class="fluent-button fluent-button-primary">
                                <i data-feather="edit-3" class="fluent-icon inline mr-2"></i>Edit Configuration
                            </button>
                        </div>
                    </div>
                    
                    <!-- Fluent Key Metrics -->
                    <div class="grid grid-cols-3 gap-6">
                        <div class="text-center p-4 rounded-lg" style="background: var(--colorNeutralBackground2);">
                            <div class="text-2xl font-semibold" style="color: var(--colorNeutralForeground1);">20241220.5</div>
                            <div class="text-sm" style="color: var(--colorNeutralForeground2);">Current Build</div>
                        </div>
                        <div class="text-center p-4 rounded-lg" style="background: var(--colorNeutralBackground2);">
                            <div class="text-2xl font-semibold" style="color: var(--colorBrandForeground1);">3</div>
                            <div class="text-sm" style="color: var(--colorNeutralForeground2);">Active Pipelines</div>
                        </div>
                        <div class="text-center p-4 rounded-lg" style="background: var(--colorNeutralBackground2);">
                            <div class="text-2xl font-semibold" style="color: var(--colorNeutralForeground1);">2h</div>
                            <div class="text-sm" style="color: var(--colorNeutralForeground2);">Last Deploy</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fluent Quick Deploy -->
            <div class="fluent-card mb-8" aria-label="Quick deploy panel">
                <div class="p-6" style="border-bottom: 1px solid var(--colorNeutralStroke2);">
                    <div class="flex items-center space-x-2">
                        <i data-feather="play" class="w-5 h-5" style="color: #107c10;"></i>
                        <h3 class="fluent-text-title2">Quick Deploy</h3>
                    </div>
                </div>
                
                <div class="p-6">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between space-y-4 lg:space-y-0">
                        <div class="flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-4">
                            <div class="flex items-center space-x-2">
                                <label class="text-sm" style="color: var(--colorNeutralForeground2);">Pipeline:</label>
                                <select id="quickPipelineSelect" class="fluent-select">
                                    <option value="1418">Main Pipeline (Default)</option>
                                    <option value="33874">Incremental Build</option>
                                    <option value="custom">Custom Pipeline</option>
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label class="text-sm" style="color: var(--colorNeutralForeground2);">Version:</label>
                                <select id="quickVersionSelect" class="fluent-select">
                                    <option value="latest">Latest (20241220.5)</option>
                                    <option value="20241220.4">20241220.4</option>
                                    <option value="20241220.3">20241220.3</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex space-x-3">
                            <button type="button" onclick="showAdvancedDeploy()" class="fluent-button fluent-button-subtle">
                                <i data-feather="settings" class="fluent-icon inline mr-2"></i>Advanced
                            </button>
                            <button type="button" onclick="quickDeploy()" class="fluent-button" style="background: #107c10; color: white;">
                                <i data-feather="play" class="fluent-icon inline mr-2"></i>Deploy Now
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fluent Pipeline Management -->
            <div class="fluent-card" aria-label="Pipeline management"><!-- no pagination; internal scroll allowed -->
                <div class="p-6" style="border-bottom: 1px solid var(--colorNeutralStroke2);">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <i data-feather="layers" class="w-5 h-5" style="color: var(--colorBrandForeground1);"></i>
                            <h3 class="fluent-text-title2">Pipeline Management</h3>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm" style="color: var(--colorNeutralForeground2);">Default:</span>
                            <span id="currentDefaultPipeline" class="fluent-badge" style="background: #e3f2fd; color: var(--colorBrandForeground1);">Main Pipeline (ID: 1418)</span>
                        </div>
                    </div>
                </div>
                
                <div class="p-6">
                    <div id="pipelineCardsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Pipeline cards will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Fluent Modals (keeping existing functionality) -->
            <!-- Set Default Pipeline Confirmation Modal -->
            <div id="setDefaultPipelineModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4">
                    <div class="p-6">
                        <div class="flex items-center mb-4">
                            <i data-feather="star" class="w-6 h-6 text-yellow-600 mr-3"></i>
                            <h3 class="text-lg font-semibold text-gray-900">Set Default Pipeline</h3>
                        </div>
                        <p class="text-gray-600 mb-4">
                            Are you sure you want to set <span id="pipelineNameToSet" class="font-semibold"></span> as the default pipeline for <span class="font-semibold">OwaMailB2</span>?
                        </p>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start space-x-3">
                                <i data-feather="info" class="w-5 h-5 text-yellow-600 mt-0.5"></i>
                                <div>
                                    <p class="text-sm font-medium text-yellow-900">Impact</p>
                                    <ul class="text-xs text-yellow-800 mt-1 space-y-1">
                                        <li>• VE batch deployment will use this pipeline by default</li>
                                        <li>• Quick Deploy allows selecting any pipeline for deployment</li>
                                        <li>• Configuration will be updated in service settings</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="px-6 py-4 border-t border-gray-100 flex justify-end space-x-3">
                        <button onclick="closeSetDefaultModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">Cancel</button>
                        <button onclick="confirmSetDefault()" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors">
                            <i data-feather="star" class="w-4 h-4 inline mr-2"></i>Set as Default
                        </button>
                    </div>
                </div>
            </div>

            <!-- Configuration Editor Modal -->
            <div id="configEditorModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center" style="z-index: 1070;">
                <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] flex flex-col">
                    <div class="p-6 border-b border-gray-100 flex-shrink-0">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <i data-feather="edit-3" class="w-6 h-6 text-purple-600"></i>
                                <h3 class="text-lg font-semibold text-gray-900">Edit Service Configuration</h3>
                            </div>
                            <button onclick="closeConfigEditor()" class="text-gray-400 hover:text-gray-600">
                                <i data-feather="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex-1 p-6 overflow-y-auto">
                        <div class="space-y-4">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-sm font-medium text-gray-700">Service: OwaMailB2</h4>
                                <div class="flex items-center space-x-2">
                                    <button onclick="validateConfig()" class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200 transition-colors text-sm">
                                        <i data-feather="check-circle" class="w-3 h-3 inline mr-1"></i>Validate
                                    </button>
                                    <button onclick="resetConfig()" class="px-3 py-1.5 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors text-sm">
                                        <i data-feather="refresh-cw" class="w-3 h-3 inline mr-1"></i>Reset
                                    </button>
                                </div>
                            </div>
                            
                            <!-- JSON Editor with enhanced validation -->
                            <div class="relative">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Configuration JSON</label>
                                <div class="border border-gray-300 rounded-lg overflow-hidden">
                                    <div class="bg-gray-50 px-4 py-2 border-b border-gray-200 flex items-center justify-between">
                                        <div class="flex items-center space-x-2">
                                            <span class="text-xs text-gray-500">JSON Editor</span>
                                            <div id="configStatus" class="flex items-center space-x-1">
                                                <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                                <span class="text-xs text-green-600">Valid</span>
                                            </div>
                                        </div>
                                        <button onclick="formatConfig()" class="text-xs text-gray-500 hover:text-gray-700">Format</button>
                                    </div>
                                    <textarea id="configEditor" class="w-full h-96 p-4 font-mono text-sm resize-none focus:outline-none" spellcheck="false">
{
  "BuildType": "RingPromotion",
  "PipelineId": 1418,
  "IncrementalBuildPipelineId": 33874,
  "RingPromotionRootPath": "autopilot",
  "BuildRoot": "https://outlookgriffinservice.blob.core.windows.net/owamailb2/prod_image.txt",
  "PpeVeName": "OwaMailB2-PPE",
  "BuildPathPattern": "VSO://https://outlookweb.artifacts.visualstudio.com/DefaultCollection/_apis/drop/drops/owamailb2_ms/<BuildVersion>?root=autopilot"
}</textarea>
                                </div>
                                
                                <!-- Validation errors display -->
                                <div id="validationErrors" class="hidden mt-2 p-3 bg-red-50 border border-red-200 rounded-md">
                                    <div class="flex items-start space-x-2">
                                        <i data-feather="alert-circle" class="w-4 h-4 text-red-500 mt-0.5"></i>
                                        <div>
                                            <h4 class="text-sm font-medium text-red-800">Configuration Errors:</h4>
                                            <ul id="errorsList" class="mt-1 text-sm text-red-700 list-disc list-inside"></ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="px-6 py-4 border-t border-gray-100 flex justify-between items-center flex-shrink-0">
                        <label class="flex items-center">
                            <input type="checkbox" id="createPRConfig" checked class="mr-2 rounded border-gray-300">
                            <span class="text-sm text-gray-700">Create Pull Request</span>
                        </label>
                        <div class="flex space-x-3">
                            <button onclick="closeConfigEditor()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">Cancel</button>
                            <button onclick="saveConfiguration()" id="saveConfigBtn" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i data-feather="save" class="w-4 h-4 inline mr-2"></i>Save Configuration
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                // Pipeline metadata and configurations
                const pipelineConfigs = {
                    1418: {
                        name: "Main Pipeline",
                        description: "Primary build pipeline for OwaMailB2",
                        type: "main",
                        color: "blue",
                        icon: "zap",
                        isDefault: true,
                        latestBuild: "20241220.5",
                        dropUrl: "VSO://https://outlookweb.artifacts.visualstudio.com/DefaultCollection/_apis/drop/drops/owamailb2_ms/20241220.5?root=autopilot"
                    },
                    33874: {
                        name: "Incremental Build",
                        description: "Fast incremental build pipeline",
                        type: "incremental",
                        color: "purple",
                        icon: "refresh-cw",
                        isDefault: false,
                        latestBuild: "20241220.3",
                        dropUrl: "VSO://https://outlookweb.artifacts.visualstudio.com/DefaultCollection/_apis/drop/drops/owamailb2_ms/20241220.3?root=autopilot"
                    },
                    31234: {
                        name: "Incremental Build Alt",
                        description: "Alternative incremental build",
                        type: "incremental",
                        color: "green", 
                        icon: "refresh-cw",
                        isDefault: false,
                        latestBuild: "20241220.2",
                        dropUrl: "VSO://https://outlookweb.artifacts.visualstudio.com/DefaultCollection/_apis/drop/drops/owamailb2_ms/20241220.2?root=autopilot"
                    }
                };

                // Global state for default pipeline management
                let pendingDefaultPipelineId = null;
                let currentDefaultPipelineId = 1418;

                // Service configuration data
                const serviceConfig = {
                    "OwaMailB2": {
                        "BuildType": "RingPromotion", 
                        "PipelineId": 1418,
                        "IncrementalBuildPipelineId": 33874,
                        "MainlineBuildPipelineId": 31234,
                        "RingPromotionRootPath": "autopilot",
                        "BuildRoot": "https://outlookgriffinservice.blob.core.windows.net/owamailb2/prod_image.txt",
                        "PpeVeName": "OwaMailB2-PPE",
                        "BuildPathPattern": "VSO://https://outlookweb.artifacts.visualstudio.com/DefaultCollection/_apis/drop/drops/owamailb2_ms/<BuildVersion>?root=autopilot"
                    }
                };

                const currentService = "OwaMailB2";

                // Initialize the page
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('Page initializing...');
                    initializePipelines();
                    updateDefaultPipelineDisplay();
                    refreshIcons();
                    console.log('Page initialization complete');
                });

                function initializePipelines() {
                    console.log('Initializing pipelines...', pipelineConfigs);
                    
                    const service = serviceConfig[currentService];
                    if (!service) {
                        console.error('Service not found:', currentService);
                        return;
                    }

                    const container = document.getElementById('pipelineCardsContainer');
                    if (!container) {
                        console.error('Pipeline container not found');
                        return;
                    }
                    
                    container.innerHTML = '';

                    // Extract all pipeline IDs from service config  
                    const pipelineIds = [];
                    if (service.PipelineId) pipelineIds.push({ id: service.PipelineId, role: 'primary' });
                    if (service.IncrementalBuildPipelineId) pipelineIds.push({ id: service.IncrementalBuildPipelineId, role: 'incremental' });
                    if (service.MainlineBuildPipelineId) pipelineIds.push({ id: service.MainlineBuildPipelineId, role: 'mainline' });

                    console.log('Found pipeline IDs:', pipelineIds);

                    // Create pipeline cards
                    pipelineIds.forEach(({ id, role }) => {
                        const config = pipelineConfigs[id];
                        if (config) {
                            console.log('Creating card for pipeline:', id, config);
                            const card = createPipelineCard(id, config, role);
                            container.appendChild(card);
                        } else {
                            console.warn('Pipeline config not found for ID:', id);
                            
                            // 为缺失的pipeline创建默认卡片
                            const defaultCard = createDefaultPipelineCard(id, role);
                            container.appendChild(defaultCard);
                        }
                    });

                    refreshIcons();
                    console.log('Pipeline initialization complete, cards created:', container.children.length);
                }

                function createPipelineCard(pipelineId, config, role) {
                    const card = document.createElement('div');
                    const isCurrentDefault = currentDefaultPipelineId == pipelineId;
                    
                    card.className = `pipeline-card rounded-lg p-4 cursor-pointer ${isCurrentDefault ? 'default-pipeline' : ''}`;
                    card.onclick = () => selectPipeline(pipelineId);

                    const statusBadge = isCurrentDefault ? 
                        `<span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded flex items-center">
                            <i data-feather="star" class="w-3 h-3 mr-1"></i>Default
                        </span>` :
                        `<span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">${config.type}</span>`;

                    card.innerHTML = `
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center space-x-2">
                                <div class="w-6 h-6 bg-gray-100 rounded flex items-center justify-center">
                                    <i data-feather="${config.icon}" class="w-3 h-3 text-gray-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-900">${config.name}</h4>
                                    <p class="text-xs text-gray-500">ID: ${pipelineId}</p>
                                </div>
                            </div>
                            ${statusBadge}
                        </div>
                        <p class="text-xs text-gray-600 mb-3">${config.description}</p>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Latest:</span>
                                <span class="font-mono text-gray-900">${config.latestBuild}</span>
                            </div>
                            <div class="bg-gray-50 rounded p-2">
                                <p class="font-mono text-xs text-gray-700 break-all">${config.dropUrl}</p>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-100 text-center">
                            ${!isCurrentDefault ? `
                                <button class="px-3 py-1.5 bg-gray-100 text-gray-700 text-sm rounded hover:bg-gray-200" onclick="event.stopPropagation(); showSetDefaultModal(${pipelineId}, '${config.name}')">
                                    <i data-feather="star" class="w-3 h-3 inline mr-1"></i>Set as Default
                                </button>
                            ` : `
                                <span class="px-3 py-1.5 bg-blue-100 text-blue-700 text-sm rounded flex items-center justify-center">
                                    <i data-feather="star" class="w-3 h-3 inline mr-1"></i>Default Pipeline
                                </span>
                            `}
                        </div>
                    `;

                    return card;
                }

                // 为缺失配置的pipeline创建默认卡片
                function createDefaultPipelineCard(pipelineId, role) {
                    const card = document.createElement('div');
                    const isCurrentDefault = currentDefaultPipelineId == pipelineId;
                    
                    card.className = `pipeline-card rounded-lg p-4 cursor-pointer ${isCurrentDefault ? 'default-pipeline' : ''}`;
                    card.onclick = () => selectPipeline(pipelineId);

                    const roleNames = {
                        'primary': 'Main Pipeline',
                        'incremental': 'Incremental Build', 
                        'mainline': 'Mainline Build'
                    };

                    const roleIcons = {
                        'primary': 'zap',
                        'incremental': 'refresh-cw',
                        'mainline': 'git-branch'
                    };

                    const statusBadge = isCurrentDefault ? 
                        `<span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded flex items-center">
                            <i data-feather="star" class="w-3 h-3 mr-1"></i>Default
                        </span>` :
                        `<span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">${role.charAt(0).toUpperCase() + role.slice(1)}</span>`;

                    card.innerHTML = `
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center space-x-2">
                                <div class="w-6 h-6 bg-gray-100 rounded flex items-center justify-center">
                                    <i data-feather="${roleIcons[role] || 'settings'}" class="w-3 h-3 text-gray-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-900">${roleNames[role] || 'Unknown Pipeline'}</h4>
                                    <p class="text-xs text-gray-500">ID: ${pipelineId}</p>
                                </div>
                            </div>
                            ${statusBadge}
                        </div>
                        <p class="text-xs text-gray-600 mb-3">Pipeline configuration not available</p>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Status:</span>
                                <span class="text-yellow-600">Configuration Missing</span>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-100 text-center">
                            ${!isCurrentDefault ? `
                                <button class="px-3 py-1.5 bg-gray-100 text-gray-700 text-sm rounded hover:bg-gray-200" onclick="event.stopPropagation(); showSetDefaultModal(${pipelineId}, '${roleNames[role] || 'Unknown Pipeline'}')">
                                    <i data-feather="star" class="w-3 h-3 inline mr-1"></i>Set as Default
                                </button>
                            ` : `
                                <span class="px-3 py-1.5 bg-blue-100 text-blue-700 text-sm rounded flex items-center justify-center">
                                    <i data-feather="star" class="w-3 h-3 inline mr-1"></i>Default Pipeline
                                </span>
                            `}
                        </div>
                    `;

                    return card;
                }

                // Pipeline management functions
                function selectPipeline(pipelineId) {
                    console.log('Pipeline selected:', pipelineId);
                    // Remove active state from all cards
                    document.querySelectorAll('.pipeline-card').forEach(card => {
                        card.classList.remove('active');
                    });
                    
                    // Add active state to selected card
                    event.currentTarget.classList.add('active');
                    
                    const config = pipelineConfigs[pipelineId];
                    const pipelineName = config ? config.name : `Pipeline ${pipelineId}`;
                    showNotification('Pipeline Selected', `${pipelineName} activated`);
                }

                function showSetDefaultModal(pipelineId, pipelineName) {
                    pendingDefaultPipelineId = pipelineId;
                    document.getElementById('pipelineNameToSet').textContent = pipelineName;
                    document.getElementById('setDefaultPipelineModal').classList.remove('hidden');
                    refreshIcons();
                }

                function closeSetDefaultModal() {
                    pendingDefaultPipelineId = null;
                    document.getElementById('setDefaultPipelineModal').classList.add('hidden');
                }

                function confirmSetDefault() {
                    if (!pendingDefaultPipelineId) return;

                    currentDefaultPipelineId = pendingDefaultPipelineId;
                    updateDefaultPipelineDisplay();
                    initializePipelines();
                    closeSetDefaultModal();
                    
                    const pipelineName = pipelineConfigs[currentDefaultPipelineId].name;
                    showNotification('Default Pipeline Updated', `${pipelineName} is now the default pipeline`);
                }

                function updateDefaultPipelineDisplay() {
                    const defaultConfig = pipelineConfigs[currentDefaultPipelineId];
                    const display = document.getElementById('currentDefaultPipeline');
                    if (display) {
                        display.textContent = `Main Pipeline (ID: ${currentDefaultPipelineId})`;
                    }
                }

                function toggleFavorite() {
                    const btn = document.getElementById('favoriteBtn');
                    const isActive = btn.classList.toggle('text-yellow-500');
                    btn.classList.toggle('text-gray-400', !isActive);
                    const serviceName = 'OwaMailB2';
                    if (isActive) {
                        if (window.addToSidebarFavorites) window.addToSidebarFavorites({ name: serviceName, query: serviceName, type:'service' });
                    } else {
                        if (window.removeFromSidebarFavorites) window.removeFromSidebarFavorites(serviceName,'service');
                     }
                     showNotification('Favorite Toggled', `${serviceName} has been ${isActive ? 'added to' : 'removed from'} favorites`);
                 }

                function showConfigEditor() {
                    document.getElementById('configEditorModal').classList.remove('hidden');
                    refreshIcons();
                }

                function closeConfigEditor() {
                    document.getElementById('configEditorModal').classList.add('hidden');
                }

                // Enhanced configuration validation
                function validateConfig() {
                    const editor = document.getElementById('configEditor');
                    const status = document.getElementById('configStatus');
                    const validationErrors = document.getElementById('validationErrors');
                    const errorsList = document.getElementById('errorsList');
                    const saveBtn = document.getElementById('saveConfigBtn');
                    
                    try {
                        const configText = editor.value.trim();
                        
                        if (!configText) {
                            throw new Error('Configuration cannot be empty');
                        }
                        
                        const config = JSON.parse(configText);
                        const errors = validateConfigStructure(config);
                        if (errors.length === 0) {
                            // Valid configuration
                            status.innerHTML = `on
                                <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                <span class="text-xs text-green-600">Valid</span>div>
                            `;  <span class="text-xs text-green-600">Valid</span>
                            editor.classList.remove('config-invalid');
                            editor.classList.add('config-valid');id');
                            validationErrors.classList.add('hidden');
                            saveBtn.disabled = false;t.add('hidden');
                        } else {Btn.disabled = false;
                            // Invalid configuration
                            status.innerHTML = `tion
                                <div class="w-2 h-2 bg-red-400 rounded-full"></div>
                                <span class="text-xs text-red-600">Invalid</span>v>
                            `;  <span class="text-xs text-red-600">Invalid</span>
                            editor.classList.remove('config-valid');
                            editor.classList.add('config-invalid');;
                            editor.classList.add('config-invalid');
                            errorsList.innerHTML = errors.map(error => `<li>${error}</li>`).join('');
                            validationErrors.classList.remove('hidden');<li>${error}</li>`).join('');
                            saveBtn.disabled = true;st.remove('hidden');
                        }   saveBtn.disabled = true;
                        }
                    } catch (e) {
                        // JSON parsing error
                        status.innerHTML = `r
                            <div class="w-2 h-2 bg-red-400 rounded-full"></div>
                            <span class="text-xs text-red-600">Invalid JSON</span>
                        `;  <span class="text-xs text-red-600">Invalid JSON</span>
                        editor.classList.remove('config-valid');
                        editor.classList.add('config-invalid');;
                        editor.classList.add('config-invalid');
                        errorsList.innerHTML = `<li>Invalid JSON syntax: ${e.message}</li>`;
                        validationErrors.classList.remove('hidden');tax: ${e.message}</li>`;
                        saveBtn.disabled = true;st.remove('hidden');
                    }   saveBtn.disabled = true;
                }   }
                }
                function validateConfigStructure(config) {
                    const errors = [];gStructure(config) {
                    const errors = [];
                    // Required fields validation
                    const requiredFields = ['BuildType', 'PipelineId', 'BuildRoot'];
                    requiredFields.forEach(field => {e', 'PipelineId', 'BuildRoot'];
                        if (!config[field]) {eld => {
                            errors.push(`Missing required field: ${field}`);
                        }   errors.push(`Missing required field: ${field}`);
                    }); }
                    });
                    // Type validation
                    if (config.PipelineId && typeof config.PipelineId !== 'number') {
                        errors.push('PipelineId must be a number');Id !== 'number') {
                    }   errors.push('PipelineId must be a number');
                    }
                    if (config.IncrementalBuildPipelineId && typeof config.IncrementalBuildPipelineId !== 'number') {
                        errors.push('IncrementalBuildPipelineId must be a number');talBuildPipelineId !== 'number') {
                    }   errors.push('IncrementalBuildPipelineId must be a number');
                    }
                    // URL validation
                    if (config.BuildRoot && !isValidUrl(config.BuildRoot)) {
                        errors.push('BuildRoot must be a valid URL');oot)) {
                    }   errors.push('BuildRoot must be a valid URL');
                    }
                    return errors;
                }   return errors;
                }
                function isValidUrl(string) {
                    try {isValidUrl(string) {
                        new URL(string);
                        return true;ng);
                    } catch (_) {ue;
                        return false;
                    }   return false;
                }   }
                }
                // Enhanced format function
                function formatConfig() {on
                    const editor = document.getElementById('configEditor');
                    const json = editor.value.trim();tById('configEditor');
                    const json = editor.value.trim();
                    if (!json) return;
                    if (!json) return;
                    try {
                        const obj = JSON.parse(json);
                        editor.value = JSON.stringify(obj, null, 2);
                        editor.classList.remove('config-invalid'););
                        validateConfig();remove('config-invalid');
                    } catch (e) {onfig();
                        showNotification('Format Error', 'Cannot format invalid JSON');
                    }   showNotification('Format Error', 'Cannot format invalid JSON');
                }   }
                }
                // Enhanced save configuration
                function saveConfiguration() {
                    const editor = document.getElementById('configEditor');
                    const createPR = document.getElementById('createPRConfig').checked;
                    const createPR = document.getElementById('createPRConfig').checked;
                    try {
                        const config = JSON.parse(editor.value);
                        const config = JSON.parse(editor.value);
                        // Show loading state
                        const saveBtn = document.getElementById('saveConfigBtn');
                        const originalText = saveBtn.innerHTML;('saveConfigBtn');
                        saveBtn.innerHTML = '<i data-feather="loader" class="w-4 h-4 inline mr-2 animate-spin"></i>Saving...';
                        saveBtn.disabled = true;data-feather="loader" class="w-4 h-4 inline mr-2 animate-spin"></i>Saving...';
                        saveBtn.disabled = true;
                        setTimeout(() => {
                            closeConfigEditor();
                            showNotification('Configuration Saved', 
                                createPR ? 'Configuration saved and PR created successfully' : 'Configuration saved successfully');
                                createPR ? 'Configuration saved and PR created successfully' : 'Configuration saved successfully');
                            // Reset button
                            saveBtn.innerHTML = originalText;
                            saveBtn.disabled = false;nalText;
                        }, 2000);tn.disabled = false;
                        }, 2000);
                    } catch (e) {
                        showNotification('Save Error', 'Cannot save invalid configuration');
                    }   showNotification('Save Error', 'Cannot save invalid configuration');
                }   }
                }
                // Add validation on input
                document.addEventListener('DOMContentLoaded', function() {
                    const editor = document.getElementById('configEditor');
                    if (editor) {= document.getElementById('configEditor');
                        let timeout;
                        editor.addEventListener('input', function() {
                            clearTimeout(timeout);nput', function() {
                            timeout = setTimeout(validateConfig, 500);
                        }); timeout = setTimeout(validateConfig, 500);
                    }   });
                    }
                    // ...existing initialization code...
                }); // ...existing initialization code...
                });
                // Unified sidebar functionality
                function toggleSidebar() {nality
                    const sidebar = document.getElementById('sidebar');
                    const overlay = document.getElementById('sidebarOverlay');
                    const overlay = document.getElementById('sidebarOverlay');
                    sidebar.classList.toggle('open');
                    overlay.classList.toggle('show');
                }   overlay.classList.toggle('show');
                }
                // Initialize sidebar state
                document.addEventListener('DOMContentLoaded', function() {
                    if (window.innerWidth >= 1024) {tLoaded', function() {
                        const sidebar = document.getElementById('sidebar');
                        sidebar.classList.add('open');ementById('sidebar');
                    }   sidebar.classList.add('open');
                }); }
                });
                // Handle window resize
                window.addEventListener('resize', function() {
                    const sidebar = document.getElementById('sidebar');
                    const overlay = document.getElementById('sidebarOverlay');
                    const overlay = document.getElementById('sidebarOverlay');
                    if (window.innerWidth >= 1024) {
                        sidebar.classList.add('open');
                        overlay.classList.remove('show');
                    } else {lay.classList.remove('show');
                        sidebar.classList.remove('open');
                        overlay.classList.remove('show');
                    }   overlay.classList.remove('show');
                }); }
            </script>
            <script>>
                window.SIDEBAR_ACTIVE = 've'; /* or 'services' if preferred */
                window.SIDEBAR_FAVORITES = [; /* or 'services' if preferred */
                    { name:'SovBase', query:'SovBase', type:'ve' },
                    { name:'ModelBSov', query:'ModelBSov', type:'ve' },
                    { name:'OwaMailB2-SOV', query:'OwaMailB2-SOV', type:'ve' }
                ];  { name:'OwaMailB2-SOV', query:'OwaMailB2-SOV' }
            </script>
            <script src="./shared/sidebar.js"></script>
            <script>src="./shared/sidebar.js"></script>
                if(window.refreshFeatherIcons) window.refreshFeatherIcons();
            </script>ndow.refreshFeatherIcons) window.refreshFeatherIcons();
        </div>script>
    </main>iv>
</body>ain>
</html>
</html>