<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OwaMailB2 - Service Detail | Griffin PF Deployment AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link rel="stylesheet" href="./shared/css/common.css">
    <link rel="stylesheet" href="./shared/css/layout.css">
    <link rel="stylesheet" href="./pages/service-detail.css">
</head>
<body>
    <a href="#mainContent" class="visually-hidden" aria-label="Skip to main content">Skip to main content</a>
    <div id="app-sidebar"></div><!-- shared sidebar injected -->
    <div class="main-content" id="mainContent" role="main" aria-label="Service Detail"><!-- no vertical scroll enforced; pagination handled where needed -->
        <!-- Fluent Navigation -->
        <nav class="fluent-card" style="margin: 0; border-radius: 0; border-left: none; border-right: none; border-top: none;">
            <div class="container mx-auto px-6">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-3">
                            <div>
                                <h1 class="text-lg font-semibold text-neutral-1">Service Detail</h1>
                                <p class="fluent-text-caption1">Cross Virtual Environment Service Management</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background: var(--colorNeutralBackground3);">
                            <i data-feather="user" class="fluent-icon" style="color: var(--colorNeutralForeground3);"></i>
                        </div>
                        <span class="text-sm" style="color: var(--colorNeutralForeground2);">John Doe</span>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container mx-auto px-6 py-8">
            <!-- Error State -->
            <div id="errorState" class="error-state hidden">
                <div class="flex items-center">
                    <i data-feather="alert-circle" class="w-5 h-5 mr-2"></i>
                    <span id="errorMessage">An error occurred while loading service data.</span>
                    <button onclick="retryLoad()" class="ml-auto px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">
                        Retry
                    </button>
                </div>
            </div>

            <!-- Breadcrumb -->
            <nav class="flex items-center space-x-2 text-sm mb-6" style="color: var(--colorNeutralForeground3);">
                <a href="services-management.html" class="hover:text-blue-600 transition-colors" style="color: var(--colorBrandForeground1);">Services Management</a>
                <i data-feather="chevron-right" class="w-4 h-4"></i>
                <span class="text-neutral-1 font-medium" id="serviceName">OwaMailB2</span>
            </nav>

            <!-- Service Header -->
            <div class="fluent-card mb-8" aria-label="Service header summary">
                <div class="p-8">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-4">
                            <div class="w-16 h-16 rounded-xl flex items-center justify-center bg-success-soft" id="serviceIcon">
                                <i data-feather="mail" class="w-8 h-8" style="color: #107c10;"></i>
                            </div>
                            <div>
                                <div class="flex items-center space-x-3 mb-1">
                                    <h1 class="fluent-text-title1" id="serviceTitle">OwaMailB2</h1>
                                    <button id="favoriteBtn" onclick="toggleFavorite()" style="color: #faa06b; transition: opacity 0.1s;" class="hover:opacity-80" title="Add to favorites">
                                        <i data-feather="star" class="w-6 h-6"></i>
                                    </button>
                                </div>
                                <p class="fluent-text-body1 mt-1" id="serviceDescription">Outlook Web App Mail Backend Service</p>
                                <div class="flex items-center space-x-4 mt-3">
                                    <span class="fluent-badge fluent-badge-success" id="serviceType">Exchange Service</span>
                                    <span class="text-sm text-neutral-3">Last updated: 2 hours ago</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button onclick="refreshData()" class="fluent-button fluent-button-subtle" title="Refresh data">
                                <i data-feather="refresh-cw" class="fluent-icon inline mr-2"></i>Refresh
                            </button>
                            <button onclick="bulkDeploy()" class="fluent-button fluent-button-primary">
                                <i data-feather="upload" class="fluent-icon inline mr-2"></i>Deploy to All VEs
                            </button>
                        </div>
                    </div>
                    
                    <!-- Service Stats Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="text-center p-4 rounded-lg border transition-all" style="border-color: var(--colorNeutralStroke2); background: var(--colorNeutralBackground2);">
                            <p class="text-3xl font-bold mb-2 text-brand" id="totalVEs">2</p>
                            <p class="text-sm" style="color: var(--colorNeutralForeground2);">Total VE Instances</p>
                        </div>
                        <div class="text-center p-4 rounded-lg border transition-all" style="border-color: var(--colorNeutralStroke2); background: var(--colorNeutralBackground2);">
                            <p class="text-3xl font-bold mb-2" style="color: #107c10;" id="deployedVEs">2</p>
                            <p class="text-sm" style="color: var(--colorNeutralForeground2);">Deployed VEs</p>
                        </div>
                        <div onclick="showPipelineManagementModal()" class="text-center p-4 rounded-lg border transition-all cursor-pointer hover:bg-blue-50" style="border-color: var(--colorNeutralStroke2); background: var(--colorNeutralBackground2);" onmouseover="this.style.borderColor='var(--colorBrandForeground1)'" onmouseout="this.style.borderColor='var(--colorNeutralStroke2)'">
                            <p class="text-3xl font-bold mb-2" style="color: #5c2d91;" id="activePipelines">3</p>
                            <p class="text-sm" style="color: var(--colorNeutralForeground2);">Active Pipelines</p>
                            <p class="text-xs mt-1 opacity-75" style="color: #5c2d91;">Click to view</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pipeline Management Modal -->
            <div id="pipelineManagementModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center" style="z-index: 1050;">
                <div class="bg-white rounded-xl shadow-xl max-w-6xl w-full mx-4 max-h-[90vh] flex flex-col">
                    <div class="p-6 border-b border-gray-100 flex-shrink-0">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <i data-feather="layers" class="w-6 h-6" style="color: var(--colorBrandForeground1);"></i>
                                <h3 class="text-lg font-semibold text-gray-900">Pipeline Management - <span id="modalServiceName">OwaMailB2</span></h3>
                            </div>
                            <button onclick="closePipelineManagementModal()" class="text-gray-400 hover:text-gray-600">
                                <i data-feather="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <p class="text-sm text-gray-500 mt-2">View all active pipelines for this service across virtual environments</p>
                    </div>
                    
                    <div class="flex-1 p-6 overflow-y-auto">
                        <div id="modalPipelineCardsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Pipeline cards will be generated here -->
                        </div>
                    </div>
                    
                    <div class="px-6 py-4 border-t border-gray-100 flex justify-end flex-shrink-0">
                        <button onclick="closePipelineManagementModal()" class="fluent-button fluent-button-subtle">
                            Close
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading Overlay -->
            <div id="loadingOverlay" class="loading-overlay hidden">
                <div class="loading-content">
                    <div class="animate-spin w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                    <h3 class="text-lg font-semibold mb-2">Processing...</h3>
                    <p id="loadingMessage">Please wait while we process your request.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="./shared/js/header.js"></script>
    <script src="./shared/js/mockData.js"></script>
    <script src="./shared/js/pageInit.js"></script>
    <script>
      // Error handling
      function showError(message) {
          document.getElementById('errorMessage').textContent = message;
          document.getElementById('errorState').classList.remove('hidden');
      }
      
      function hideError() {
          document.getElementById('errorState').classList.add('hidden');
      }
      
      function retryLoad() {
          hideError();
          initializePage();
      }
      
      // Loading states
      function showLoading(message = 'Loading...') {
          document.getElementById('loadingMessage').textContent = message;
          document.getElementById('loadingOverlay').classList.remove('hidden');
      }
      
      function hideLoading() {
          document.getElementById('loadingOverlay').classList.add('hidden');
      }
      
      function showTableLoading() {
          document.getElementById('tableLoadingState').classList.remove('hidden');
          document.getElementById('tableContainer').style.opacity = '0.5';
      }
      
      function hideTableLoading() {
          document.getElementById('tableLoadingState').classList.add('hidden');
          document.getElementById('tableContainer').style.opacity = '1';
      }
      
      // --- Dynamic Service Model from MockData ---
      function getServiceNameFromURL(){
        const p=new URLSearchParams(location.search);
        return p.get('service')||'OwaMailB2';
      }

      const serviceDetailState = { model:null };

      function populateHeader(model){
        document.getElementById('serviceName').textContent = model.name;
        document.getElementById('serviceTitle').textContent = model.name;
        document.getElementById('serviceDescription').textContent = model.description;
        document.getElementById('serviceType').textContent = model.type;
        document.getElementById('totalVEs').textContent = model.totalCount;
        document.getElementById('deployedVEs').textContent = model.deployedCount;
        document.getElementById('activePipelines').textContent = model.pipelines.length;
        const favBtn = document.getElementById('favoriteBtn');
        if(favBtn){
          favBtn.classList.toggle('active', model.favorite);
          if(model.favorite) favBtn.setAttribute('aria-pressed','true'); else favBtn.setAttribute('aria-pressed','false');
        }
      }
      function buildPipelineCards(model){
        const container = document.getElementById('modalPipelineCardsContainer');
        if(!container) return;
        container.innerHTML='';
        model.pipelines.forEach(cfg=>{
          container.appendChild(createViewOnlyPipelineCard(cfg.id, {
            name: cfg.type + ' Pipeline',
            id: cfg.id,
            type: cfg.type,
            icon: cfg.icon,
            color: cfg.color,
            latestBuild: cfg.latestBuild,
            dropUrl: cfg.dropUrl,
            description: cfg.description
          }));
        });
      }

      function showPipelineManagementModal(){
        if(!serviceDetailState.model) return;
        document.getElementById('modalServiceName').textContent = serviceDetailState.model.name;
        buildPipelineCards(serviceDetailState.model);
        document.getElementById('pipelineManagementModal').classList.remove('hidden');
        if(window.refreshFeatherIcons) window.refreshFeatherIcons();
      }
      window.showPipelineManagementModal = showPipelineManagementModal;

      function toggleFavorite(){
        if(!serviceDetailState.model) return;
        const btn=document.getElementById('favoriteBtn');
        const now = btn.classList.toggle('active');
        serviceDetailState.model.favorite = now;
        if(now){
          if(window.addToSidebarFavorites) window.addToSidebarFavorites({ name: serviceDetailState.model.name, type:'service' });
        } else {
          if(window.removeFromSidebarFavorites) window.removeFromSidebarFavorites(serviceDetailState.model.name,'service');
        }
        if(window.refreshFeatherIcons) window.refreshFeatherIcons();
      }
      window.toggleFavorite = toggleFavorite;

      function initializeServiceDetail(data){
        const svcName = getServiceNameFromURL();
        const models = (data && data.serviceModels) || {};
        let model = models[svcName];
        if(!model){
          showError('Service "'+svcName+'" not found in mock data.');
          return;
        }
        serviceDetailState.model = model;
        ensureSidebarFavorites(data);
        populateHeader(model);
        buildPipelineCards(model);
        if(window.refreshFeatherIcons) window.refreshFeatherIcons();
      }

      function ensureSidebarFavorites(data){
        if(!Array.isArray(window.SIDEBAR_FAVORITES) || !window.SIDEBAR_FAVORITES.length){
          const vFav = (data.favorites && (data.favorites.VEs || [])) || [];
          window.SIDEBAR_FAVORITES = vFav.slice(0,3).map(n=>({ name:n, type:'ve'}));
        }
      }

      // Copy URL helper (unchanged)
      function copyDropUrl(url) {
          navigator.clipboard.writeText(url).then(() => {
              showNotification('URL Copied', 'Drop URL has been copied to clipboard');
          }, (err) => {
              console.error('Copy failed', err);
              showNotification('Copy Failed', 'Unable to copy URL to clipboard');
          });
      }

      // Close Pipeline Management Modal
      function closePipelineManagementModal() {
          document.getElementById('pipelineManagementModal').classList.add('hidden');
      }

      // REPLACED broken createViewOnlyPipelineCard + malformed markup & listeners
      function createViewOnlyPipelineCard(pipelineId, config) {
          const card = document.createElement('div');
          card.className = 'fluent-card p-4 cursor-default';

          const colorClasses = {
              blue: 'bg-blue-100 text-blue-700',
              purple: 'bg-purple-100 text-purple-700',
              green: 'bg-green-100 text-green-700'
          };

          card.innerHTML = `
              <div class="flex items-start justify-between mb-3">
                  <div class="flex items-center space-x-2">
                      <div class="w-6 h-6 bg-gray-100 rounded flex items-center justify-center">
                          <i data-feather="${config.icon}" class="w-3 h-3 text-gray-600"></i>
                      </div>
                      <div>
                          <h4 class="font-medium text-gray-900">${config.name}</h4>
                          <p class="text-xs text-gray-500">ID: ${pipelineId}</p>
                      </div>
                  </div>
                  <span class="px-2 py-1 ${colorClasses[config.color] || 'bg-gray-100 text-gray-700'} text-xs rounded">${config.type}</span>
              </div>
              <p class="text-xs text-gray-600 mb-3">${config.description}</p>
              <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                      <span class="text-gray-600">Latest Build:</span>
                      <span class="font-mono text-gray-900">${config.latestBuild}</span>
                  </div>
                  <div class="bg-gray-50 rounded p-2">
                      <div class="flex items-center justify-between">
                          <p class="font-mono text-xs text-gray-700 break-all flex-1 mr-2">${config.dropUrl}</p>
                          <button onclick="copyDropUrl('${config.dropUrl}')" class="px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-xs transition-colors" title="Copy URL">
                              <i data-feather="copy" class="w-3 h-3"></i>
                          </button>
                      </div>
                  </div>
              </div>
              <div class="mt-3 pt-3 border-t border-gray-100 text-center">
                  <span class="text-xs text-gray-500">Pipeline Status: Active</span>
              </div>
          `;
          return card;
      }

      // Clean modal close handlers
      document.addEventListener('click', function (event) {
          const modal = document.getElementById('pipelineManagementModal');
          if (event.target === modal) {
              closePipelineManagementModal();
          }
      });
      document.addEventListener('keydown', function (event) {
          if (event.key === 'Escape') {
              const modal = document.getElementById('pipelineManagementModal');
              if (modal && !modal.classList.contains('hidden')) {
                  closePipelineManagementModal();
              }
          }
      });

      // Bootstrap
      (function start(){
        if(window.initPageWithMockData){
          initPageWithMockData(initializeServiceDetail, { requireDetails:true });
        } else {
          initializeServiceDetail(window.MockData||{});
        }
      })();

      // Re-init if dataset was late
      window.addEventListener('MockDataReady', function(){
        if(!serviceDetailState.model){
          initializeServiceDetail(window.MockData||{});
        }
      });
    </script>
    <script>
      // Sidebar context (active + seed favorites) - keep after dynamic init script
      window.SIDEBAR_ACTIVE = 'services';
      window.SIDEBAR_FAVORITES = window.SIDEBAR_FAVORITES || [
        { name:'SovBase', type:'ve' },
        { name:'ModelBSov', type:'ve' },
        { name:'OwaMailB2-SOV', type:'ve' }
      ];
    </script>
    <script src="./shared/js/sidebar.js"></script>
    <script>
        if (window.refreshFeatherIcons) window.refreshFeatherIcons();
    </script>
</body>
</html>