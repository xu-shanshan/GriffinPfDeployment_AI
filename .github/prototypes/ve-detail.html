<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SovBase - Virtual Environment Detail | Griffin PF Deployment AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link rel="stylesheet" href="./shared/fluent-ui.css">
    <link rel="stylesheet" href="./shared/common.css"><!-- added unified layout -->
    <style>
        /* Page-specific (trimmed; removed global design tokens & sidebar layout) */
        .config-actions { opacity:0; transition:opacity .2s; }
        .table-row:hover .config-actions { opacity:1; }
        .search-highlight { background:rgba(59,130,246,.1); border:2px solid #3B82F6; }
    </style>
</head>
<body>
    <a href="#mainContent" class="visually-hidden" aria-label="Skip to main content">Skip to main content</a>
    <div id="app-sidebar"></div><!-- shared sidebar injection -->

    <main class="main-content" id="mainContent" role="main" aria-label="Virtual Environment Detail">
        <header class="top-bar" role="banner">
            <div class="web-container">
                <div class="flex justify-between items-center h-app-header">
                    <div>
                        <h1 class="text-lg font-semibold page-title">SovBase - Virtual Environment</h1>
                        <p class="fluent-text-caption1">Virtual Environment Management</p>
                    </div>
                    <div class="user-profile">
                        <div class="user-avatar">
                            <i data-feather="user" class="fluent-icon user-icon" aria-hidden="true"></i>
                        </div>
                        <span class="text-sm user-name">John Doe</span>
                    </div>
                </div>
            </div>
        </header>

        <div class="web-container content-area">
            <!-- Breadcrumb -->
            <nav class="flex items-center space-x-2 text-sm mb-6 text-muted">
                <a href="ve-management.html" class="text-accent hover:underline">VE Management</a>
                <i data-feather="chevron-right" class="fluent-icon" aria-hidden="true"></i>
                <span class="font-medium text-fg-strong">SovBase</span>
            </nav>

            <!-- VE Header Card -->
            <div class="fluent-card section-spacing">
                <div class="p-8">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
                        <div class="flex items-center gap-6">
                            <div class="w-16 h-16 rounded-xl flex items-center justify-center bg-info-soft">
                                <i data-feather="server" class="text-white" style="width:32px;height:32px;" aria-hidden="true"></i>
                            </div>
                            <div>
                                <div class="flex items-center gap-3 mb-1">
                                    <h1 class="fluent-text-title1 m-0">SovBase</h1>
                                    <button id="favoriteBtn" type="button" aria-label="Toggle favorite"
                                            class="star-toggle active" onclick="toggleFavorite()">
                                        <i data-feather="star" aria-hidden="true"></i>
                                    </button>
                                </div>
                                <p class="fluent-text-body1 mt-1">Base sovereign virtual environment for core services</p>
                                <div class="flex items-center flex-wrap gap-4 mt-3">
                                    <span class="fluent-badge fluent-badge-neutral">B Type VE</span>
                                    <span class="fluent-text-caption1 text-muted">Last updated: 2 hours ago</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <button type="button" onclick="refreshData(event)" class="fluent-button fluent-button-subtle">
                                <i data-feather="refresh-cw" class="fluent-icon mr-2" aria-hidden="true"></i>Refresh
                            </button>
                            <button type="button" class="fluent-button fluent-button-primary">
                                <i data-feather="edit" class="fluent-icon mr-2" aria-hidden="true"></i>Edit Config
                            </button>
                        </div>
                    </div>
                    <!-- Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
                        <button type="button" onclick="filterByConfigSource('dragon')"
                                class="fluent-card p-4 hover:shadow-sm transition">
                            <p class="text-3xl font-semibold text-accent mb-1">89</p>
                            <p class="fluent-text-body1">Dragon GriffinServiceMap.ini</p>
                            <p class="fluent-text-caption1 text-accent mt-1 opacity-0 group-hover:opacity-100">Click to filter</p>
                        </button>
                        <button type="button" onclick="filterByConfigSource('pfgold')"
                                class="fluent-card p-4 hover:shadow-sm transition">
                            <p class="text-3xl font-semibold text-fg-strong mb-1">67</p>
                            <p class="fluent-text-body1">PFGold deployment.ini</p>
                        </button>
                        <button type="button" onclick="filterByStatus('deployed')"
                                class="fluent-card p-4 hover:shadow-sm transition">
                            <p class="text-3xl font-semibold text-success mb-1">62</p>
                            <p class="fluent-text-body1">Deployed</p>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Services Table Card -->
            <div class="fluent-card">
                <div class="p-6 border-b border-gray-100 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <h2 class="fluent-text-title2 m-0">Services in SovBase VE</h2>
                        <span id="selectedCount" class="hidden fluent-badge fluent-badge-neutral">0 selected</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <select id="statusFilter" onchange="applyFilters()" class="fluent-select">
                            <option value="">All Status</option>
                            <option value="ready">Ready</option>
                            <option value="prepared">Prepared</option>
                            <option value="not-deployed">Not Deployed</option>
                            <option value="missing-pfgold">Missing PFGold</option>
                            <option value="config-error">Config Error</option>
                        </select>
                        <select id="configFilter" onchange="applyFilters()" class="fluent-select">
                            <option value="">All Config</option>
                            <option value="both">Dragon & PFGold</option>
                            <option value="dragon-only">Dragon only</option>
                            <option value="pfgold-only">PFGold only</option>
                        </select>
                        <input id="searchInput" aria-label="Search services" placeholder="Search services..."
                               class="fluent-input w-56" oninput="performSearch()">
                        <button type="button" class="fluent-button fluent-button-subtle" onclick="clearAllFilters()">Reset</button>
                        <button type="button" id="bulkDeployBtn" class="fluent-button fluent-button-primary" disabled onclick="showBulkDeployModal()">
                            Bulk Deploy
                        </button>
                    </div>
                </div>
                <div><!-- removed overflow-x-auto previously -->
                    <table class="min-w-full" id="servicesTable" aria-label="Services in this virtual environment" style="width:100%;table-layout:auto;">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-4 w-12">
                                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="rounded border-gray-300">
                                </th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Service Name</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th scope="col" class="px-6 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Dragon</th>
                                <th scope="col" class="px-6 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">PFGold</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Version</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Default Pipeline</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="servicesTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <div class="px-6 py-4 border-t border-gray-100 flex flex-col md:flex-row gap-4 md:items-center md:justify-between">
                    <div class="flex items-center gap-4">
                        <span id="tableInfo" class="fluent-text-caption1">Showing 0 services</span>
                        <div id="activeFilters" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div class="flex items-center gap-2">
                        <select id="pageSize" onchange="updatePageSize()" class="fluent-select">
                            <option value="10">10 / page</option>
                            <option value="25">25 / page</option>
                            <option value="50">50 / page</option>
                        </select>
                        <nav id="pagination" class="flex gap-1"></nav>
                    </div>
                </div>
            </div>

            <!-- Bulk Deploy Modal -->
            <div id="bulkDeployModal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50">
                <div class="fluent-card w-full max-w-md">
                    <div class="p-6">
                        <div class="flex items-center mb-4">
                            <i data-feather="upload" class="fluent-icon mr-3" aria-hidden="true"></i>
                            <h3 class="fluent-text-title2 m-0">Deploy Selected Services</h3>
                        </div>
                        <p class="fluent-text-body1 mb-4">Deploy <span id="deployCount" class="font-semibold">0</span> selected service(s)?</p>
                        <div class="p-4 rounded-lg" style="background:#e3f2fd;">
                            <h4 class="fluent-text-caption1 mb-2 text-accent">Selected Services:</h4>
                            <ul id="deployServicesList" class="text-sm space-y-1"></ul>
                        </div>
                    </div>
                    <div class="px-6 py-4 flex justify-end gap-3 border-t border-gray-100">
                        <button type="button" class="fluent-button fluent-button-subtle" onclick="hideBulkDeployModal()">Cancel</button>
                        <button type="button" class="fluent-button fluent-button-primary" onclick="confirmBulkDeploy()">
                            <i data-feather="upload" class="fluent-icon mr-2" aria-hidden="true"></i>Deploy Now
                        </button>
                    </div>
                </div>
            </div>

            <!-- Notification -->
            <div id="notification" class="fixed top-4 right-4 hidden fluent-card p-4 z-50" role="alert" aria-live="polite">
                <strong id="notification-title" class="block mb-1"></strong>
                <span id="notification-message" class="fluent-text-body1"></span>
            </div>
        </div>
    </main>

    <script>
        // Global state management
        const appState = {
            services: [
                {
                    id: 'owamailb2',
                    name: 'OwaMailB2',
                    description: 'Outlook Web App Mail Backend',
                    status: 'ready',
                    inDragon: true,
                    inPFGold: true,
                    currentVersion: 'v2.1.234',
                    pipeline: 'ExchangeMailPipeline',
                    pipelineVersion: 'v3.2.1',
                    icon: 'mail',
                    iconColor: 'blue',
                    readyToDeploy: true
                },
                {
                    id: 'graphconnectors',
                    name: 'GraphConnectors',
                    description: 'Graph Connectors Service',
                    status: 'not-deployed',
                    inDragon: true,
                    inPFGold: true,
                    currentVersion: null,
                    pipeline: 'GraphConnectorsPipeline',
                    pipelineVersion: 'v2.8.5',
                    icon: 'zap',
                    iconColor: 'orange',
                    readyToDeploy: false
                },
                {
                    id: 'flowcontrol',
                    name: 'FlowControl',
                    description: 'Flow Control Service',
                    status: 'missing-pfgold',
                    inDragon: true,
                    inPFGold: false,
                    currentVersion: null,
                    pipeline: 'FlowControlPipeline',
                    pipelineVersion: 'v1.9.3',
                    icon: 'activity',
                    iconColor: 'yellow',
                    readyToDeploy: false
                },
                {
                    id: 'invalidservice',
                    name: 'InvalidService',
                    description: 'Service not in Dragon map',
                    status: 'config-error',
                    inDragon: false,
                    inPFGold: true,
                    currentVersion: 'v1.0.0',
                    pipeline: null,
                    pipelineVersion: null,
                    icon: 'alert-circle',
                    iconColor: 'red',
                    readyToDeploy: false
                }
            ],
            filteredServices: [],
            selectedServices: new Set(),
            currentSort: null,
            currentFilters: {},
            currentPage: 1,
            pageSize: 10
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeServices();
            updateUI();
            if (window.refreshFeatherIcons) window.refreshFeatherIcons();
        });

        // Service management functions
        function initializeServices() {
            appState.filteredServices = [...appState.services];
            renderServicesTable();
        }

        function renderServicesTable() {
            const tbody = document.getElementById('servicesTableBody');
            tbody.innerHTML = '';
            appState.filteredServices.forEach(service => {
                tbody.appendChild(createServiceRow(service));
            });
            updateTableInfo();
            if (window.refreshFeatherIcons) window.refreshFeatherIcons();
        }

        function createServiceRow(service) {
            const row = document.createElement('tr');
            row.className = 'table-row hover:bg-gray-50 transition-colors';
            row.dataset.serviceId = service.id;

            const canSelect = service.status === 'ready' || (service.status === 'not-deployed' && service.readyToDeploy);
            const statusConfig = getStatusConfig(service.status, service.readyToDeploy);

            row.innerHTML = `
                <td class="px-6 py-4">
                    <input type="checkbox" ${canSelect ? '' : 'disabled'}
                           onchange="toggleServiceSelection('${service.id}')"
                           class="rounded border-gray-300 service-checkbox" data-service-id="${service.id}">
                </td>
                <td class="px-6 py-4">
                    <div class="flex items-center space-x-3">
                        <a href="ve-service-detail.html?ve=SovBase&service=${service.id}"
                           class="text-gray-900 font-medium hover:text-blue-600 transition-colors">${service.name}</a>
                    </div>
                </td>
                <td class="px-6 py-4">${statusConfig.badge}</td>
                <td class="px-6 py-4 text-center">${createConfigStatus(service.inDragon)}</td>
                <td class="px-6 py-4 text-center">${createConfigStatus(service.inPFGold)}</td>
                <td class="px-6 py-4 font-mono text-sm ${service.currentVersion ? 'text-gray-900' : 'text-gray-400'}">
                    ${service.currentVersion || 'null'}
                </td>
                <td class="px-6 py-4">
                    ${service.pipeline ? `
                        <div class="font-mono text-sm text-gray-900">${service.pipeline}</div>
                        <div class="text-xs text-gray-500 mt-1">Latest: ${service.pipelineVersion}</div>
                    ` : '<span class="font-mono text-sm text-gray-400">-</span>'}
                </td>
                <td class="px-6 py-4">
                    <div class="config-actions">${createActionButtons(service)}</div>
                </td>
            `;

            return row;
        }

        function getStatusConfig(status, readyToDeploy = false) {
            const configs = {
                'ready': {
                    badge: '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full">Ready to Deploy</span>'
                },
                'not-deployed': {
                    badge: readyToDeploy 
                        ? '<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">Prepared for Deployment</span>'
                        : '<span class="px-2 py-1 bg-gray-100 text-gray-800 text-xs font-medium rounded-full">Not Deployed</span>'
                },
                'missing-pfgold': {
                    badge: '<div class="flex items-center space-x-2"><span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-medium rounded-full">Missing in PFGold</span><i data-feather="alert-triangle" class="w-4 h-4 text-yellow-500"></i></div>'
                },
                'config-error': {
                    badge: '<div class="flex items-center space-x-2"><span class="px-2 py-1 bg-red-100 text-red-800 text-xs font-medium rounded-full">Configuration Error</span><i data-feather="x-circle" class="w-4 h-4 text-red-500"></i></div>'
                }
            };
            return configs[status] || configs['not-deployed'];
        }

        function createConfigStatus(isPresent) {
            return isPresent 
                ? '<div class="flex items-center justify-center"><i data-feather="check-circle" class="w-4 h-4 text-green-500"></i></div>'
                : '<div class="flex items-center justify-center"><i data-feather="x-circle" class="w-4 h-4 text-red-500"></i></div>';
        }

        function createActionButtons(service) {
            if (service.status === 'missing-pfgold') {
                return `
                    <div class="flex space-x-2">
                        <button onclick="addToPFGold('${service.id}')" class="px-3 py-1.5 bg-yellow-600 text-white text-sm rounded-lg hover:bg-yellow-700 transition-colors">
                            Add to PFGold
                        </button>
                        <button onclick="removeFromDragon('${service.id}')" class="px-3 py-1.5 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 transition-colors">
                            Remove from Dragon
                        </button>
                    </div>
                `;
            } else if (service.status === 'config-error') {
                return `
                    <div class="flex space-x-2">
                        <button onclick="removeFromPFGold('${service.id}')" class="px-3 py-1.5 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 transition-colors">
                            Remove from PFGold
                        </button>
                        <button onclick="addToDragon('${service.id}')" class="px-3 py-1.5 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition-colors">
                            Add to Dragon
                        </button>
                    </div>
                `;
            } else if (service.status === 'not-deployed') {
                if (service.readyToDeploy) {
                    return `
                        <div class="flex space-x-2">
                            <button onclick="cancelPrepareForDeployment('${service.id}')" class="px-3 py-1.5 bg-gray-600 text-white text-sm rounded-lg hover:bg-gray-700 transition-colors">
                                <i data-feather="x" class="w-3 h-3 inline mr-1"></i>Cancel Preparation
                            </button>
                        </div>
                    `;
                } else {
                    return `
                        <div class="flex space-x-2">
                            <button onclick="prepareForDeployment('${service.id}')" class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors">
                                <i data-feather="check-circle" class="w-3 h-3 inline mr-1"></i>Prepare for Deployment
                            </button>
                        </div>
                    `;
                }
            }
            return '';
        }

        // Search and filter functionality
        function performSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (!query) {
                applyFilters();
                return;
            }

            appState.filteredServices = appState.services.filter(service => 
                service.name.toLowerCase().includes(query) ||
                service.description.toLowerCase().includes(query) ||
                (service.pipeline && service.pipeline.toLowerCase().includes(query))
            );

            renderServicesTable();
            updateActiveFilters();
        }

        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const configFilter = document.getElementById('configFilter').value;

            appState.filteredServices = appState.services.filter(service => {
                let matchesStatus = true;
                
                if (statusFilter === 'ready') {
                    matchesStatus = service.status === 'ready';
                } else if (statusFilter === 'not-deployed') {
                    matchesStatus = service.status === 'not-deployed' && !service.readyToDeploy;
                } else if (statusFilter === 'prepared') {
                    matchesStatus = service.status === 'not-deployed' && service.readyToDeploy;
                } else if (statusFilter === 'missing-pfgold') {
                    matchesStatus = service.status === 'missing-pfgold';
                } else if (statusFilter === 'config-error') {
                    matchesStatus = service.status === 'config-error';
                }

                let matchesConfig = true;
                if (configFilter === 'both') {
                    matchesConfig = service.inDragon && service.inPFGold;
                } else if (configFilter === 'dragon-only') {
                    matchesConfig = service.inDragon && !service.inPFGold;
                } else if (configFilter === 'pfgold-only') {
                    matchesConfig = !service.inDragon && service.inPFGold;
                }

                return matchesStatus && matchesConfig;
            });

            renderServicesTable();
            updateActiveFilters();
        }

        function clearAllFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('configFilter').value = '';
            appState.filteredServices = [...appState.services];
            renderServicesTable();
            updateActiveFilters();
        }

        function updateActiveFilters() {
            const container = document.getElementById('activeFilters');
            container.innerHTML = '';

            const searchQuery = document.getElementById('searchInput').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const configFilter = document.getElementById('configFilter').value;

            if (searchQuery) {
                container.appendChild(createFilterTag('Search', searchQuery));
            }
            if (statusFilter) {
                container.appendChild(createFilterTag('Status', statusFilter));
            }
            if (configFilter) {
                container.appendChild(createFilterTag('Config', configFilter));
            }
        }

        function createFilterTag(label, value) {
            const tag = document.createElement('span');
            tag.className = 'inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800';
            tag.innerHTML = `${label}: ${value} <button onclick="this.parentElement.remove()" class="ml-1 text-blue-600 hover:text-blue-800"><i data-feather="x" class="w-3 h-3"></i></button>`;
            return tag;
        }

        // Selection management
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.service-checkbox:not(:disabled)');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
                const serviceId = checkbox.dataset.serviceId;
                if (selectAll.checked) {
                    appState.selectedServices.add(serviceId);
                } else {
                    appState.selectedServices.delete(serviceId);
                }
            });

            updateSelectionUI();
        }

        function toggleServiceSelection(serviceId) {
            if (appState.selectedServices.has(serviceId)) {
                appState.selectedServices.delete(serviceId);
            } else {
                appState.selectedServices.add(serviceId);
            }
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const count = appState.selectedServices.size;
            const selectedCount = document.getElementById('selectedCount');
            const bulkDeployBtn = document.getElementById('bulkDeployBtn');

            if (count > 0) {
                selectedCount.classList.remove('hidden');
                selectedCount.textContent = `${count} selected`;
                bulkDeployBtn.disabled = false;
            } else {
                selectedCount.classList.add('hidden');
                bulkDeployBtn.disabled = true;
            }
        }

        // Modal management
        function showBulkDeployModal() {
            const selectedServices = Array.from(appState.selectedServices).map(id =>
                appState.services.find(s => s.id === id)
            );
            document.getElementById('deployCount').textContent = selectedServices.length;
            document.getElementById('deployServicesList').innerHTML = selectedServices.map(s =>
                `<li class="flex items-center gap-2">
                    <i data-feather="${s.icon}" class="fluent-icon" aria-hidden="true"></i>
                    <span>${s.name}</span>
                 </li>`).join('');
            document.getElementById('bulkDeployModal').classList.remove('hidden');
            if (window.refreshFeatherIcons) window.refreshFeatherIcons();
        }

        function hideBulkDeployModal() {
            document.getElementById('bulkDeployModal').classList.add('hidden');
        }

        function confirmBulkDeploy() {
            const selectedServiceNames = Array.from(appState.selectedServices).map(id => 
                appState.services.find(s => s.id === id).name
            );
            
            showNotification('Deployment Started', `Deploying ${selectedServiceNames.length} services...`);
            hideBulkDeployModal();
            
            // Clear selections
            appState.selectedServices.clear();
            document.querySelectorAll('.service-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('selectAll').checked = false;
            updateSelectionUI();
        }

        // Action handlers
        function addToPFGold(serviceId) {
            const service = appState.services.find(s => s.id === serviceId);
            showNotification('Configuration Update', `Adding ${service.name} to PFGold deployment.ini...`);
        }

        function removeFromDragon(serviceId) {
            const service = appState.services.find(s => s.id === serviceId);
            showNotification('Configuration Update', `Removing ${service.name} from Dragon GriffinServiceMap.ini...`);
        }

        function removeFromPFGold(serviceId) {
            const service = appState.services.find(s => s.id === serviceId);
            showNotification('Configuration Update', `Removing ${service.name} from PFGold deployment.ini...`);
        }

        function addToDragon(serviceId) {
            const service = appState.services.find(s => s.id === serviceId);
            showNotification('Configuration Update', `Adding ${service.name} to Dragon GriffinServiceMap.ini...`);
        }

        // 新增：准备部署功能
        function prepareForDeployment(serviceId) {
            const service = appState.services.find(s => s.id === serviceId);
            if (service && service.status === 'not-deployed') {
                service.readyToDeploy = true;
                renderServicesTable();
                showNotification('Deployment Preparation', `${service.name} is now prepared for deployment and can be selected`);
            }
        }

        // 新增：取消准备部署功能
        function cancelPrepareForDeployment(serviceId) {
            const service = appState.services.find(s => s.id === serviceId);
            if (service && service.status === 'not-deployed') {
                service.readyToDeploy = false;
                
                // 如果服务已被选中，需要取消选中
                if (appState.selectedServices.has(serviceId)) {
                    appState.selectedServices.delete(serviceId);
                    updateSelectionUI();
                }
                
                renderServicesTable();
                showNotification('Deployment Preparation', `${service.name} preparation cancelled and removed from selection`);
            }
        }

        // Utility functions
        function showNotification(title, message) {
            const n = document.getElementById('notification');
            document.getElementById('notification-title').textContent = title;
            document.getElementById('notification-message').textContent = message;
            n.classList.remove('hidden');
            setTimeout(()=>n.classList.add('hidden'),3000);
        }

        function hideNotification() {
            document.getElementById('notification').classList.remove('show');
        }

        function toggleFavorite() {
            const btn = document.getElementById('favoriteBtn');
            const icon = btn.querySelector('i');
            const veName = 'SovBase';
            const becomingFavorite = !icon.classList.contains('fill-current');
            if (becomingFavorite) {
                icon.classList.add('fill-current');
                btn.title = 'Remove from favorites';
                showNotification('Favorites', 'Added to favorites');
                if (window.addToSidebarFavorites) window.addToSidebarFavorites({ name: veName, query: veName, type:'ve' });
            } else {
                icon.classList.remove('fill-current');
                btn.title = 'Add to favorites';
                showNotification('Favorites', 'Removed from favorites');
                if (window.removeFromSidebarFavorites) window.removeFromSidebarFavorites(veName,'ve');
            }
        }

        function refreshData(event) {
            const btn = event.target.closest('button');
            const icon = btn.querySelector('i');
            
            icon.style.transform = 'rotate(360deg)';
            btn.disabled = true;
            
            setTimeout(() => {
                icon.style.transform = '';
                btn.disabled = false;
                showNotification('Data Refreshed', 'Service data has been updated');
            }, 1500);
        }

        function updateTableInfo() {
            const total = appState.services.length;
            const filtered = appState.filteredServices.length;
            const info = document.getElementById('tableInfo');
            
            if (filtered === total) {
                info.textContent = `Showing ${filtered} service${filtered !== 1 ? 's' : ''}`;
            } else {
                info.textContent = `Showing ${filtered} of ${total} services`;
            }
        }

        function updateUI() {
            updateTableInfo();
            updateSelectionUI();
            updateActiveFilters();
        }

        // Quick filter functions for stats cards
        function filterByConfigSource(source) {
            clearAllFilters();
            if (source === 'dragon') {
                appState.filteredServices = appState.services.filter(s => s.inDragon);
            } else if (source === 'pfgold') {
                appState.filteredServices = appState.services.filter(s => s.inPFGold);
            }
            renderServicesTable();
        }

        function filterByStatus(status) {
            clearAllFilters();
            if (status === 'deployed') {
                appState.filteredServices = appState.services.filter(s => s.currentVersion);
            }
            renderServicesTable();
        }

        // Unified sidebar functionality
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }
        
        // Initialize sidebar state
        document.addEventListener('DOMContentLoaded', function() {
            if (window.innerWidth >= 1024) {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.add('open');
            }
        });
    </script>
    <script>
        window.SIDEBAR_ACTIVE = 've';
        window.SIDEBAR_FAVORITES = [
            { name:'SovBase', query:'SovBase', type:'ve' },
            { name:'ModelBSov', query:'ModelBSov', type:'ve' },
            { name:'OwaMailB2-SOV', query:'OwaMailB2-SOV', type:'ve' }
        ];
    </script>
    <script src="./shared/sidebar.js"></script>
    <script>
        if (window.refreshFeatherIcons) window.refreshFeatherIcons();
    </script>
</body>
</html>