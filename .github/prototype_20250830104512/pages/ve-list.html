<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>VE List - Griffin Deployment Prototype</title>
<link rel="stylesheet" href="../shared/common.css">
<script src="../shared/common.js"></script>
<script src="../shared/mock-data.js"></script>
<script src="../shared/Layout/header.js"></script>
<script src="../shared/Layout/footer.js"></script>
<script src="../shared/Layout/sidebar.js"></script>
<script src="../shared/commonComponent/card.js"></script>
<script src="../shared/commonComponent/modal.js"></script>
<script src="../shared/commonComponent/tooltip.js"></script>
</head>
<body>
<div class="layout" id="app"></div>
<script>
(function(G){
  const root = G.qs('#app');
  root.appendChild(G.Layout.renderSidebar('ves'));
  root.appendChild(G.Layout.renderHeader());
  const main = document.createElement('main');
  main.className='layout-main';
  root.appendChild(main);
  root.appendChild(G.Layout.renderFooter());

  main.innerHTML = `
    <h1>Virtual Environments</h1>
    <div class="filter-bar">
      <input type="text" class="input" placeholder="Search VE..." data-search />
      <select class="input" data-filter-type>
        <option value="">All Types</option>
        <option value="B">B</option>
        <option value="B2">B2</option>
      </select>
      <select class="input" data-filter-env>
        <option value="">All Environments</option>
        <option value="APE">APE</option>
        <option value="CPE">CPE</option>
      </select>
    </div>
    <div class="grid cols-3" data-ve-grid></div>
  `;

  const grid = main.querySelector('[data-ve-grid]');
  function render(){
    const text = main.querySelector('[data-search]').value.toLowerCase();
    const tType = main.querySelector('[data-filter-type]').value;
    const tEnv = main.querySelector('[data-filter-env]').value;
    grid.innerHTML = '';
    G.data.VEs
      .filter(v=>!text || v.name.toLowerCase().includes(text))
      .filter(v=>!tType || v.type===tType)
      .filter(v=>!tEnv || v.environment===tEnv)
      .forEach(ve=>{
        const deployDisabled = !G.canDeploy();
        const card = G.Components.Card({
          title: ve.name,
          right: `<span class="badge">${ve.type}</span>`,
          body: `
            <div style="display:flex; align-items:center; gap:8px;">
              <span class="status-dot ${ve.health!=='ok'? (ve.health==='warn'?'warn':'danger'):''}"></span>
              <span class="text-dim">${ve.environment}</span>
            </div>
            <div class="text-dim">${ve.servicesCount} services</div>
            <div class="taglist">
              <span class="chip">${ve.type} type</span>
              <span class="chip">${ve.environment}</span>
            </div>
            <div style="display:flex; gap:8px; margin-top:8px;">
              <button data-view="${ve.name}" class="secondary">View</button>
              <button data-deploy="${ve.name}" ${deployDisabled?'disabled data-tooltip="No deploy permission"':''}>Deploy All</button>
            </div>
          `
        });
        grid.appendChild(card);
      });
    if(!grid.children.length){
      grid.innerHTML = `<div class="empty">No VEs match filters.</div>`;
    }
  }
  render();
  ['input','change'].forEach(evt=>{
    main.querySelectorAll('[data-search],[data-filter-type],[data-filter-env]').forEach(el=>el.addEventListener(evt, render));
  });

  G.delegate(grid,'[data-view]','click',(e,el)=>{
    const ve = el.getAttribute('data-view');
    window.location.href = `ve-detail.html?ve=${encodeURIComponent(ve)}`;
  });
  G.delegate(grid,'[data-deploy]','click',(e,el)=>{
    const ve = el.getAttribute('data-deploy');
    G.Modal.open('deployVe',{
      title:'Confirm Deployment',
      body:`Deploy all services under <strong>${ve}</strong>?`,
      actions:[
        { key:'cancel', label:'Cancel', variant:'secondary', onClick:({close})=>close() },
        { key:'deploy', label:'Deploy', onClick:({close})=>{
            G.pub('deploy:start',{ ve, services: (G.data.Services[ve]||[]).map(s=>s.name) });
            close();
          }}
      ]
    });
  });
  G.sub('data:replace', ()=>{
    render();
  });
})(window.GMS);
</script>
</body>
</html>
