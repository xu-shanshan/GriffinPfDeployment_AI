<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Griffin PF Deployment AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link rel="stylesheet" href="./shared/css/common.css">
    <link rel="stylesheet" href="./shared/css/layout.css"><!-- new layout split -->
    <style>
      /* Non-scrolling full viewport layout */
      html, body, .main-content { height:100vh; overflow:hidden; }
      .content-area {
        display:flex;
        flex-direction:column;
        height:calc(100vh - var(--app-header-height, 64px));
        overflow:hidden;
      }
      .welcome-section { flex-shrink:0; }
      .stats-section { flex-shrink:0; }
      .favorites-grid { flex:1 1 auto; overflow:hidden; } /* remove internal scroll */
      /* Safety: avoid horizontal scroll */
      body, .main-content, .web-container { max-width:100%; overflow-x:hidden; }
      :root { --favorites-bottom-gap: 32px; --favorites-compact-threshold: 7; }
      .favorites-grid { position:relative; }
      .favorites-grid-wrap {
         padding-bottom: var(--favorites-bottom-gap); /* ensures visual space above page bottom */
         transition: padding .2s ease;
      }
      /* Compact density when many favorites */
      .favorites-grid-wrap.compact .favorites-content { padding: 0.85rem 1rem 0.5rem; }
      .favorites-grid-wrap.compact .favorite-item { padding: 0.55rem 0.65rem !important; }
      .favorites-grid-wrap.compact .favorite-name { font-size: 0.875rem; }
      .favorites-grid-wrap.compact .favorite-meta span,
      .favorites-grid-wrap.compact .favorite-timestamp span { font-size: 0.6875rem; }
      .favorites-grid-wrap.compact .favorite-timestamp { gap: .5rem; }
      .favorites-grid-wrap.compact .favorites-header { padding: 1.0rem 1.0rem .75rem; }
      .favorites-grid-wrap.compact .favorites-header h3 { font-size: 1rem; line-height:1.25rem; }

     /* Multi-level compaction for favorites (level 0 = normal) */
     .favorites-grid-wrap.compact-1 .favorites-header { padding:1.0rem 1.0rem .75rem; }
     .favorites-grid-wrap.compact-1 .favorites-content { padding:0.9rem 1.0rem 0.6rem; }
     .favorites-grid-wrap.compact-1 .favorite-item { padding:0.65rem 0.75rem !important; }
     .favorites-grid-wrap.compact-1 .favorite-name { font-size:.9rem; }
     .favorites-grid-wrap.compact-1 .favorite-meta span,
     .favorites-grid-wrap.compact-1 .favorite-timestamp span { font-size:.7rem; }

     .favorites-grid-wrap.compact-2 .favorites-header { padding:.75rem .75rem .5rem; }
     .favorites-grid-wrap.compact-2 .favorites-header h3 { font-size:.9rem; line-height:1.15rem; }
     .favorites-grid-wrap.compact-2 .favorites-content { padding:.6rem .65rem .45rem; }
     .favorites-grid-wrap.compact-2 .favorite-item { padding:.45rem .5rem !important; }
     .favorites-grid-wrap.compact-2 .favorite-name { font-size:.8rem; }
     .favorites-grid-wrap.compact-2 .favorite-meta span,
     .favorites-grid-wrap.compact-2 .favorite-timestamp span { font-size:.62rem; }
     .favorites-grid-wrap.compact-2 .favorite-timestamp { gap:.4rem; }

      /* Two-column favorites override */
      .favorites-grid-wrap.two-col {
        display:grid;
        grid-template-columns:repeat(2,minmax(0,1fr));
        align-items:start;
      }
      @media (max-width: 900px){
        .favorites-grid-wrap.two-col { grid-template-columns:1fr; }
      }
    </style>
</head>
<body>
    <a href="#mainContent" class="visually-hidden" aria-label="Skip to main content">Skip to main content</a>
    <div id="app-sidebar"></div>

    <!-- Main Content -->
    <main class="main-content" id="mainContent" role="main" aria-label="Dashboard main content">
        <div id="app-header"></div>
        <div class="web-container content-area">
            <!-- Stats Cards -->
            <section class="stats-section section-spacing" aria-label="System statistics">
                <div id="statsCards" class="stats-grid"></div>
            </section>

            <!-- Favorites Grid -->
            <section class="favorites-grid">
                <div class="favorites-grid-wrap two-col">
                    <!-- Favorite VEs Section -->
                    <article class="favorites-card">
                        <header class="favorites-header">
                            <div class="favorites-title">
                                <i data-feather="star" class="star-icon" aria-hidden="true"></i>
                                <h3 class="fluent-text-title2">Favorite Virtual Environments</h3>
                            </div>
                            <button class="fluent-button fluent-button-subtle" data-navigate="ve-management.html">View All</button>
                        </header>
                        
                        <div class="favorites-content">
                            <div id="favoriteVEs" class="favorites-list"></div>
                        </div>
                    </article>

                    <!-- Favorite Services Section -->
                    <article class="favorites-card">
                        <header class="favorites-header">
                            <div class="favorites-title">
                                <i data-feather="heart" class="heart-icon" aria-hidden="true"></i>
                                <h3 class="fluent-text-title2">Favorite Services</h3>
                            </div>
                            <button class="fluent-button fluent-button-subtle" data-navigate="services-management.html">View All</button>
                        </header>
                        
                        <div class="favorites-content">
                            <div id="favoriteServices" class="favorites-list"></div>
                        </div>
                    </article>
                </div>
            </section>
        </div>
    </main>

    <script src="./shared/auth-mock.js"></script>
    <script src="./shared/mock-backend-data.js"></script>
    <script src="./shared/mock-frontend-data.js"></script>
    <script>
  // Reworked: removed network fetch; data comes from shared/mock-data.js
  function el(tag, cls='', html=''){ const e=document.createElement(tag); if(cls) e.className=cls; if(html) e.innerHTML=html; return e; }

  function deriveModel(data){
    if(!data) return null;
    const veGroups = Object.values(data.ExpectedVEs||{});
    const allVEs = [...new Set(veGroups.flat())];
    const expectedServices = data.ExpectedServices || {};
    const allServices = [...new Set(Object.values(expectedServices).flat())];
    return { allVEs, expectedServices, allServices };
  }

  function buildStats(model){
    if(!model){
      return [
        { icon:'database', color:'blue', number:0, label:'Total VEs', badge:{text:'unavailable', type:'neutral'} },
        { icon:'layers', color:'green', number:0, label:'Services', badge:{text:'unavailable', type:'neutral'} },
        { icon:'upload-cloud', color:'orange', number:0, label:'Recent Deployments', badge:{text:'placeholder', type:'info'} }
      ];
    }
    return [
      { icon:'database', color:'blue', number:model.allVEs.length, label:'Total VEs', badge:{text:`${model.allVEs.length} loaded`, type:'success'}, footerIcon:'trending-up', navigate:'ve-management.html' },
      { icon:'layers', color:'green', number:model.allServices.length, label:'Services', badge:{text:`Across ${model.allVEs.length} VEs`, type:'success'}, footerIcon:'layers', navigate:'services-management.html' },
      { icon:'upload-cloud', color:'orange', number:23, label:'Recent Deployments', badge:{text:'Last 24h (mock)', type:'info'}, footerIcon:'clock', navigate:'deployment-history.html' }
    ];
  }

  function renderStats(stats){
    const wrap=document.getElementById('statsCards');
    wrap.innerHTML='';
    stats.forEach(s=>{
      const a = el('article','stat-card');
      if(s.navigate) a.dataset.navigate = s.navigate;
      a.innerHTML = `
        <div class="stat-card-header">
          <div class="stat-icon stat-icon-${s.color}"><i data-feather="${s.icon}"></i></div>
          <div class="stat-content">
            <div class="stat-number">${s.number}</div>
            <div class="fluent-text-body1">${s.label}</div>
          </div>
        </div>
        <hr class="stat-divider">
        <div class="stat-footer">
          <span class="fluent-badge fluent-badge-${s.badge.type}">${s.badge.text}</span>
          ${s.footerIcon?`<i data-feather="${s.footerIcon}" class="trend-icon"></i>`:''}
        </div>`;
      wrap.appendChild(a);
    });
  }

  function renderFavoriteVEs(list){
    const wrap=document.getElementById('favoriteVEs');
    wrap.innerHTML='';
    list.forEach(entry=>{
      const v = typeof entry === 'string' ? { name:entry } : entry;
      const typeBadgeClass = v.typeClass ? `fluent-badge-${v.typeClass}` : 'fluent-badge-neutral';
      const servicesCount = (v.services!=null ? v.services : '-') + (v.services!=null ? ' services':'');
      const badge = v.type ? `<span class="fluent-badge ${typeBadgeClass}">${v.type}</span>`
                           : `<span class="fluent-badge fluent-badge-neutral">VE</span>`;
      const d=el('div','favorite-item');
      d.dataset.navigate=`ve-detail.html?ve=${encodeURIComponent(v.name)}`;
      d.innerHTML = `
        <div class="favorite-item-content">
          <div class="favorite-details">
            <h4 class="favorite-name">${v.name}</h4>
            <div class="favorite-meta">
              <span class="fluent-text-body1">${servicesCount}</span>
              ${badge}
            </div>
          </div>
        </div>
        <div class="favorite-timestamp">
          <span>${v.updated || '—'}</span>
          <i data-feather="chevron-right" class="fluent-icon"></i>
        </div>`;
      wrap.appendChild(d);
    });
  }

  function renderFavoriteServices(list){
    const wrap=document.getElementById('favoriteServices');
    wrap.innerHTML='';
    list.forEach(entry=>{
      const s = typeof entry === 'string' ? { name:entry } : entry;
      const statusClass = s.statusClass ? `fluent-badge-${s.statusClass}` : 'fluent-badge-success';
      const instances = s.instances!=null ? `${s.instances} VE ${s.instances===1?'instance':'instances'}` : 'Service';
      const badge = s.status ? `<span class="fluent-badge ${statusClass}">${s.status}</span>`
                             : `<span class="fluent-badge fluent-badge-success">Active</span>`;
      const d=el('div','favorite-item');
      d.dataset.navigate=`service-detail.html?service=${encodeURIComponent(s.name)}`;
      d.innerHTML=`
        <div class="favorite-item-content">
          <div class="favorite-details">
            <h4 class="favorite-name">${s.name}</h4>
            <div class="favorite-meta">
              <span class="fluent-text-body1">${instances}</span>
              ${badge}
            </div>
          </div>
        </div>
        <div class="favorite-timestamp">
          <span>${s.updated || '—'}</span>
          <i data-feather="chevron-right" class="fluent-icon"></i>
        </div>`;
      wrap.appendChild(d);
    });
  }

  function animateNumbers(){
    document.querySelectorAll('#statsCards .stat-number').forEach(el=>{
      const target = +el.textContent;
      el.textContent='0';
      const start=performance.now(), dur=800;
      function step(now){
        const p=Math.min(1,(now-start)/dur);
        el.textContent = Math.round(target*p);
        if(p<1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    });
  }

  function enableNavigation(){
    document.body.addEventListener('click',e=>{
      const t=e.target.closest('[data-navigate]');
      if(t) location.href=t.dataset.navigate;
    });
  }

  function pickFavorites(model){
    // Prefer rich metadata arrays if present
    const richVE = window.MockFavorites?.favoriteVEs;
    const richSvc = window.MockFavorites?.favoriteServices;
    if (Array.isArray(richVE) && richVE.length && Array.isArray(richSvc) && richSvc.length) {
      return {
        favVEs: richVE.slice(0,3),
        favSvcs: richSvc.slice(0,3)
      };
    }
    // Fallback to name-only arrays
    const allVEs = model?.allVEs || [];
    const allServices = model?.allServices || [];
    const namesVE = (window.MockFavorites?.VEs || []).filter(v=>allVEs.includes(v)).slice(0,3);
    const namesSvc = (window.MockFavorites?.Services || []).filter(s=>allServices.includes(s)).slice(0,3);
    return {
      favVEs: namesVE.length ? namesVE : allVEs.slice(0,3),
      favSvcs: namesSvc.length ? namesSvc : allServices.slice(0,3)
    };
  }

  function initDashboard(){
    const data = window.MockReleaseMapping || null;
    let model = deriveModel(data);

    // NEW: Reconcile with buildVeDetails() (source used by ve-management)
    if (typeof buildVeDetails === 'function') {
      try {
        const veDetailsData = buildVeDetails().dataset || [];
        if (veDetailsData.length) {
          const unifiedVeNames = Array.from(new Set(veDetailsData.map(v => v.name)));
          // If model missing or counts differ, adopt unified list to keep dashboard consistent
          if (!model || unifiedVeNames.length !== (model.allVEs?.length || 0)) {
            model = model || {};
            model.allVEs = unifiedVeNames;
            // Preserve existing expectedServices; if absent, create minimal map from veDetails services if available
            if (!model.expectedServices) model.expectedServices = {};
          }
        }
      } catch(e) {
        console.warn('[dashboard] buildVeDetails reconciliation failed', e);
      }
    }

    const stats = buildStats(model);
    renderStats(stats);

    const { favVEs, favSvcs } = pickFavorites(model);
    renderFavoriteVEs(favVEs);
    renderFavoriteServices(favSvcs);

    if(window.setSidebarFavorites){
      window.setSidebarFavorites([
        ...favVEs.map(v=>({ name: (typeof v==='string'?v:v.name), type:'ve' })),
        ...favSvcs.map(s=>({ name: (typeof s==='string'?s:s.name), type:'service' }))
      ]);
    }
    if(window.refreshFeatherIcons) window.refreshFeatherIcons();
    animateNumbers();
  }

  const debounce=(fn,d=150)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),d);}};

  document.addEventListener('DOMContentLoaded', () => {
    enableNavigation();
    initDashboard();
    window.addEventListener('resize', debounce(()=>{},120));
  });
    </script>
    <script>
        // Sidebar context early (empty favorites; will be updated after fetch)
        window.SIDEBAR_ACTIVE='dashboard';
        window.SIDEBAR_FAVORITES=[];
    </script>
    <script src="./shared/js/sidebar.js"></script>
    <script src="./shared/js/header.js"></script>
    <script>
    const userCtx = (window.Auth && Auth.getUser()) || { name:'Guest' };
    initHeader({ title:'Dashboard', subtitle:'Virtual Environment Management', user:userCtx });
  </script>
</body>
</html>