<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Griffin PF Deployment AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link rel="stylesheet" href="./shared/css/common.css">
    <link rel="stylesheet" href="./shared/css/layout.css">
    <link rel="stylesheet" href="./pages/dashboard.css">
</head>
<body>
    <a href="#mainContent" class="visually-hidden" aria-label="Skip to main content">Skip to main content</a>
    <div id="app-sidebar"></div>

    <!-- Main Content -->
    <main class="main-content" id="mainContent" role="main" aria-label="Dashboard main content">
        <div id="app-header"></div>
        <div class="web-container content-area">
            <!-- Stats Cards -->
            <section class="stats-section section-spacing" aria-label="System statistics">
                <div id="statsCards" class="stats-grid"></div>
            </section>

            <!-- Favorites Grid -->
            <section class="favorites-grid">
                <div class="favorites-grid-wrap two-col">
                    <!-- Favorite VEs Section -->
                    <article class="favorites-card">
                        <header class="favorites-header">
                            <div class="favorites-title">
                                <i data-feather="star" class="star-icon" aria-hidden="true"></i>
                                <h3 class="fluent-text-title2">Favorite Virtual Environments</h3>
                            </div>
                            <button class="fluent-button fluent-button-subtle" data-navigate="ve-management.html">View All</button>
                        </header>
                        
                        <div class="favorites-content">
                            <div id="favoriteVEs" class="favorites-list"></div>
                        </div>
                    </article>

                    <!-- Favorite Services Section -->
                    <article class="favorites-card">
                        <header class="favorites-header">
                            <div class="favorites-title">
                                <i data-feather="heart" class="heart-icon" aria-hidden="true"></i>
                                <h3 class="fluent-text-title2">Favorite Services</h3>
                            </div>
                            <button class="fluent-button fluent-button-subtle" data-navigate="services-management.html">View All</button>
                        </header>
                        
                        <div class="favorites-content">
                            <div id="favoriteServices" class="favorites-list"></div>
                        </div>
                    </article>
                </div>
            </section>
        </div>
    </main>

    <script src="./shared/js/auth-mock.js"></script>
    <script src="./shared/js/mockData.js"></script>
    <script>
  function el(tag, cls='', html=''){ const e=document.createElement(tag); if(cls) e.className=cls; if(html) e.innerHTML=html; return e; }


  function buildStats(model){
    if(!model){
      return [
        { icon:'database', color:'blue', number:0, label:'Total VEs', badge:{text:'unavailable', type:'neutral'} },
        { icon:'layers', color:'green', number:0, label:'Services', badge:{text:'unavailable', type:'neutral'} },
        { icon:'upload-cloud', color:'orange', number:0, label:'Recent Deployments', badge:{text:'placeholder', type:'info'} }
      ];
    }
    return [
      { icon:'database', color:'blue', number:model.allVEs.length, label:'Total VEs', badge:{text:`${model.allVEs.length} loaded`, type:'success'}, footerIcon:'trending-up', navigate:'ve-management.html' },
      { icon:'layers', color:'green', number:model.allServices.length, label:'Services', badge:{text:`Across ${model.allVEs.length} VEs`, type:'success'}, footerIcon:'layers', navigate:'services-management.html' },
      { icon:'upload-cloud', color:'orange', number:23, label:'Recent Deployments', badge:{text:'Last 24h (mock)', type:'info'}, footerIcon:'clock', navigate:'deployment-history.html' }
    ];
  }

  function renderStats(stats){
    const wrap=document.getElementById('statsCards');
    wrap.innerHTML='';
    stats.forEach(s=>{
      const a = el('article','stat-card');
      if(s.navigate) a.dataset.navigate = s.navigate;
      a.innerHTML = `
        <div class="stat-card-header">
          <div class="stat-icon stat-icon-${s.color}"><i data-feather="${s.icon}"></i></div>
          <div class="stat-content">
            <div class="stat-number">${s.number}</div>
            <div class="fluent-text-body1">${s.label}</div>
          </div>
        </div>
        <hr class="stat-divider">
        <div class="stat-footer">
          <span class="fluent-badge fluent-badge-${s.badge.type}">${s.badge.text}</span>
          ${s.footerIcon?`<i data-feather="${s.footerIcon}" class="trend-icon"></i>`:''}
        </div>`;
      wrap.appendChild(a);
    });
  }

  function renderFavoriteVEs(list){
    const wrap=document.getElementById('favoriteVEs');
    wrap.innerHTML='';
    list.forEach(entry=>{
      const v = typeof entry === 'string' ? { name:entry } : entry;
      const typeBadgeClass = v.typeClass ? `fluent-badge-${v.typeClass}` : 'fluent-badge-neutral';
      const servicesCount = (v.services!=null ? v.services : '-') + (v.services!=null ? ' services':'');
      const badge = v.type ? `<span class="fluent-badge ${typeBadgeClass}">${v.type}</span>`
                           : `<span class="fluent-badge fluent-badge-neutral">VE</span>`;
      const d=el('div','favorite-item');
      d.dataset.navigate=`ve-detail.html?ve=${encodeURIComponent(v.name)}`;
      d.innerHTML = `
        <div class="favorite-item-content">
          <div class="favorite-details">
            <h4 class="favorite-name">${v.name}</h4>
            <div class="favorite-meta">
              <span class="fluent-text-body1">${servicesCount}</span>
              ${badge}
            </div>
          </div>
        </div>
        <div class="favorite-timestamp">
          <span>${v.updated || '—'}</span>
          <i data-feather="chevron-right" class="fluent-icon"></i>
        </div>
        `;
      wrap.appendChild(d);
    });
  }

  function renderFavoriteServices(list){
    const wrap=document.getElementById('favoriteServices');
    wrap.innerHTML='';
    list.forEach(entry=>{
      const s = typeof entry === 'string' ? { name:entry } : entry;
      const statusClass = s.statusClass ? `fluent-badge-${s.statusClass}` : 'fluent-badge-success';
      const instances = s.instances!=null ? `${s.instances} VE ${s.instances===1?'instance':'instances'}` : 'Service';
      const badge = s.status ? `<span class="fluent-badge ${statusClass}">${s.status}</span>`
                             : `<span class="fluent-badge fluent-badge-success">Active</span>`;
      const d=el('div','favorite-item');
      d.dataset.navigate=`service-detail.html?service=${encodeURIComponent(s.name)}`;
      d.innerHTML=`
        <div class="favorite-item-content">
          <div class="favorite-details">
            <h4 class="favorite-name">${s.name}</h4>
            <div class="favorite-meta">
              <span class="fluent-text-body1">${instances}</span>
              ${badge}
            </div>
          </div>
        </div>
        <div class="favorite-timestamp">
          <span>${s.updated || '—'}</span>
          <i data-feather="chevron-right" class="fluent-icon"></i>
        </div>
        `;
      wrap.appendChild(d);
    });
  }

  function animateNumbers(){
    document.querySelectorAll('#statsCards .stat-number').forEach(el=>{
      const target = +el.textContent;
      el.textContent='0';
      const start=performance.now(), dur=800;
      function step(now){
        const p=Math.min(1,(now-start)/dur);
        el.textContent = Math.round(target*p);
        if(p<1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    });
  }

  function enableNavigation(){
    document.body.addEventListener('click',e=>{
      const t=e.target.closest('[data-navigate]');
      if(t) location.href=t.dataset.navigate;
    });
  }

  function pickFavorites(model){
    // Prefer rich metadata arrays if present
    const richVE = window.MockFavorites?.favoriteVEs;
    const richSvc = window.MockFavorites?.favoriteServices;
    if (Array.isArray(richVE) && richVE.length && Array.isArray(richSvc) && richSvc.length) {
      return {
        favVEs: richVE.slice(0,3),
        favSvcs: richSvc.slice(0,3)
      };
    }
    // Fallback to name-only arrays
    const allVEs = model?.allVEs || [];
    const allServices = model?.allServices || [];
    const namesVE = (window.MockFavorites?.VEs || []).filter(v=>allVEs.includes(v)).slice(0,3);
    const namesSvc = (window.MockFavorites?.Services || []).filter(s=>allServices.includes(s)).slice(0,3);
    return {
      favVEs: namesVE.length ? namesVE : allVEs.slice(0,3),
      favSvcs: namesSvc.length ? namesSvc : allServices.slice(0,3)
    };
  }

  function initDashboard(){
    var data = window.MockData || {};

    var veServicesMap = data.veServicesMap || {};
    var veDetails = Array.isArray(data.veDetails) ? data.veDetails : [];
    var allVEs = data.allVEs && data.allVEs.length ? data.allVEs : veDetails.map(function(v){return v.name;});
    var allServices = data.allServices && data.allServices.length ? data.allServices : (function(){ var acc={}; Object.keys(veServicesMap).forEach(function(ve){ (veServicesMap[ve]||[]).forEach(function(s){ acc[s]=true; }); }); return Object.keys(acc); })();
  
    var model =  { allVEs, veServicesMap, allServices, vesInfo: veDetails };
    
    const stats = buildStats(model);
    renderStats(stats);
    const { favVEs, favSvcs } = pickFavorites(model.MockFavorites);
    renderFavoriteVEs(favVEs);
    renderFavoriteServices(favSvcs);

    if(window.setSidebarFavorites){
      window.setSidebarFavorites([
        ...favVEs.map(v=>({ name: (typeof v==='string'?v:v.name), type:'ve' })),
        ...favSvcs.map(s=>({ name: (typeof s==='string'?s:s.name), type:'service' }))
      ]);
    }
    if(window.refreshFeatherIcons) window.refreshFeatherIcons();
    animateNumbers();
  }

  const debounce=(fn,d=150)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),d);}};

  document.addEventListener('DOMContentLoaded', () => {
    enableNavigation();
    initDashboard();
    window.addEventListener('resize', debounce(()=>{},120));
  });
    </script>
    <script>
        // Sidebar context early (empty favorites; will be updated after fetch)
        window.SIDEBAR_ACTIVE='dashboard';
        window.SIDEBAR_FAVORITES=[];
    </script>
    <script src="./shared/js/sidebar.js"></script>
    <script src="./shared/js/header.js"></script>
    <script>
    const userCtx = (window.Auth && Auth.getUser()) || { name:'Guest' };
    initHeader({ title:'Dashboard', subtitle:'Virtual Environment Management', user:userCtx });
  </script>
</body>
</html>